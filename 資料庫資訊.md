YOLOv11 æ•¸ä½é›™ç”Ÿåˆ†æç³»çµ± - è³‡æ–™åº« Schema å°ç…§
==========================================================
ä¾æ“š `deployment/db/init.sql`ï¼ˆ2025-11-14ï¼‰æ•´ç†ï¼Œåˆ—å‡ºç›®å‰å¯¦éš›å»ºç«‹çš„è³‡æ–™è¡¨èˆ‡æ¬„ä½ï¼Œç¢ºä¿æ–‡ä»¶èˆ‡ç¨‹å¼ä¸€è‡´ã€‚

ğŸ“‹ è³‡æ–™è¡¨ç¸½è¦½ï¼ˆ9 å¼µï¼‰
----------------------------------------------------------
1. `data_sources`  â”€â”€ è³‡æ–™ä¾†æºï¼ˆæ”å½±æ©Ÿ / å½±ç‰‡ï¼‰
2. `analysis_tasks` â”€â”€ åˆ†æä»»å‹™ä¸»æª”
3. `detection_results` â”€â”€ é€å¹€æª¢æ¸¬çµæœ
4. `line_crossing_events` â”€â”€ ç©¿è¶Šç·šäº‹ä»¶
5. `zone_dwell_events` â”€â”€ å€åŸŸåœç•™äº‹ä»¶
6. `speed_events` â”€â”€ é€Ÿåº¦ç•°å¸¸äº‹ä»¶
7. `users` â”€â”€ ä½¿ç”¨è€…ï¼ˆé¸æ“‡æ€§å•Ÿç”¨ï¼‰
8. `system_config` â”€â”€ å…¨åŸŸè¨­å®š
9. `task_statistics` â”€â”€ ä»»å‹™å³æ™‚çµ±è¨ˆ

å„è¡¨æ¬„ä½èˆ‡å‹åˆ¥
----------------------------------------------------------
### 1. data_sources
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK | ä¸»éµ |
| source_type | VARCHAR(20) NOT NULL | `camera`ï½œ`video_file` |
| name | VARCHAR(100) NOT NULL | ä¾†æºåç¨± |
| config | JSONB | å­˜æ”¾ RTSPã€æª”æ¡ˆè·¯å¾‘ç­‰è¨­å®š |
| status | VARCHAR(20) NOT NULL DEFAULT `active` | `active`ï½œ`inactive`ï½œ`error` |
| last_check | TIMESTAMPTZ | æœ€è¿‘å¥åº·æª¢æŸ¥æ™‚é–“ |
| created_at | TIMESTAMPTZ DEFAULT NOW() | å»ºç«‹æ™‚é–“ |
ç´¢å¼•ï¼š`idx_data_sources_status`

### 2. analysis_tasks
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK | ä¸»éµ |
| task_type | VARCHAR(20) NOT NULL | `realtime_camera`ï½œ`video_file` |
| status | VARCHAR(20) NOT NULL | `pending`ï½œ`running`ï½œ`paused`ï½œ`completed`ï½œ`failed` |
| source_id | BIGINT FK â†’ data_sources.id | ä¾†æºé—œè¯ï¼Œå¯ç‚º NULL |
| source_width / source_height / source_fps | INTEGER / INTEGER / FLOAT | ä»»å‹™åŸ·è¡Œæ™‚è¨ˆç®—çš„ä¾†æºè¦æ ¼ |
| start_time / end_time | TIMESTAMPTZ | ä»»å‹™èµ·è¨– |
| created_at | TIMESTAMPTZ DEFAULT NOW() | å»ºç«‹æ™‚é–“ |
| task_name | VARCHAR(200) | é¡¯ç¤ºåç¨± |
| camera_id / camera_name / camera_type | VARCHAR(100) / VARCHAR(200) / VARCHAR(50) | æ”å½±æ©Ÿè³‡è¨Š |
| device_index | INTEGER | æœ¬æ©Ÿæ”å½±æ©Ÿ index |
| model_path / model_id | VARCHAR(255) / VARCHAR(100) | YOLO æ¨¡å‹è³‡è¨Š |
| confidence_threshold / iou_threshold | FLOAT DEFAULT 0.5 / FLOAT DEFAULT 0.4 | æ¨è«–é–¾å€¼ |
ç´¢å¼•ï¼š`idx_analysis_tasks_status`ã€`idx_analysis_tasks_created`ã€`idx_analysis_tasks_source`

### 3. detection_results
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK | ä¸»éµ |
| task_id | BIGINT NOT NULL FK â†’ analysis_tasks.id ON DELETE CASCADE | ä»»å‹™é—œè¯ |
| tracker_id | BIGINT | è¿½è¹¤ IDï¼ˆè·¨å¹€ä¸²è¯ï¼‰ |
| object_speed | FLOAT | ç•¶ä¸‹é€Ÿåº¦ï¼ˆå¯ç‚º NULLï¼‰ |
| zones | JSONB | ä½æ–¼å“ªäº›å€åŸŸï¼ˆå…è¨±å¤šå€ï¼‰ |
| frame_number | INTEGER | å¹€ç·¨è™Ÿ |
| frame_timestamp | TIMESTAMPTZ DEFAULT NOW() | æª¢æ¸¬æ™‚é–“ |
| object_type | VARCHAR(50) | ç‰©ä»¶é¡å‹ |
| confidence | FLOAT | ä¿¡å¿ƒåº¦ 0~1 |
| bbox_x1 / bbox_y1 / bbox_x2 / bbox_y2 | FLOAT | é‚Šç•Œæ¡†åº§æ¨™ï¼ˆåƒç´ ï¼‰ |
| center_x / center_y | FLOAT | ä¸­å¿ƒé»åº§æ¨™ |
ç´¢å¼•ï¼š`idx_detection_results_task`ã€`idx_detection_results_tracker`ã€`idx_detection_results_timestamp`

ğŸ‘‰ è‹¥è¦é¡¯ç¤ºç¸®åœ–æˆ–å½±ç‰‡ç‰‡æ®µï¼Œå¯å†æ–°å¢ `thumbnail_path`ï¼`clip_path` ç­‰æ¬„ä½ï¼Œä¸¦åœ¨æœå‹™å±¤å¯«å…¥ã€‚

### 4. line_crossing_events
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK |
| is_enabled | BOOLEAN DEFAULT TRUE |
| task_id | BIGINT NOT NULL FK â†’ analysis_tasks.id ON DELETE CASCADE |
| tracker_id | BIGINT | è§¸ç™¼è€…è¿½è¹¤ ID |
| line_id | VARCHAR(50) NOT NULL | ç·šæ®µè­˜åˆ¥ç¢¼ |
| direction | VARCHAR(20) | `in` / `out` ç­‰æ–¹å‘ |
| frame_number | INTEGER |
| frame_timestamp | TIMESTAMPTZ DEFAULT NOW() |
| extra | JSONB | å…¶ä»–è³‡è¨Š |
ç´¢å¼•ï¼š`idx_line_events_task_line`ã€`idx_line_events_tracker`

### 5. zone_dwell_events
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK |
| is_enabled | BOOLEAN DEFAULT TRUE |
| task_id | BIGINT NOT NULL FK â†’ analysis_tasks.id ON DELETE CASCADE |
| tracker_id | BIGINT |
| zone_id | VARCHAR(50) NOT NULL |
| entered_at / exited_at | TIMESTAMPTZ | é€²å‡ºæ™‚é–“ |
| dwell_seconds | FLOAT | åœç•™ç§’æ•¸ |
| frame_number | INTEGER |
| event_timestamp | TIMESTAMPTZ DEFAULT NOW() |
| extra | JSONB |
ç´¢å¼•ï¼š`idx_zone_events_task_zone`ã€`idx_zone_events_tracker`

### 6. speed_events
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK |
| is_enabled | BOOLEAN DEFAULT TRUE |
| task_id | BIGINT NOT NULL FK â†’ analysis_tasks.id ON DELETE CASCADE |
| tracker_id | BIGINT |
| speed_avg / speed_max | FLOAT | å¹³å‡ / æœ€å¤§é€Ÿåº¦ |
| threshold | FLOAT | è§¸ç™¼é–€æª» |
| frame_number | INTEGER |
| event_timestamp | TIMESTAMPTZ DEFAULT NOW() |
| extra | JSONB |
ç´¢å¼•ï¼š`idx_speed_events_task`ã€`idx_speed_events_tracker`

### 7. usersï¼ˆè¦åŠƒä¸­ï¼‰
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK |
| username | VARCHAR(50) UNIQUE NOT NULL |
| password_hash | VARCHAR(255) NOT NULL |
| role | VARCHAR(20) NOT NULL DEFAULT `viewer` | `admin`ï½œ`operator`ï½œ`viewer` |
| is_active | BOOLEAN DEFAULT TRUE |
| last_login | TIMESTAMPTZ |
| created_at | TIMESTAMPTZ DEFAULT NOW() |

### 8. system_config
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| id | BIGSERIAL PK |
| config_key | VARCHAR(100) UNIQUE NOT NULL |
| config_value | TEXT |
| description | TEXT |
| updated_at | TIMESTAMPTZ DEFAULT NOW() |

### 9. task_statistics
| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- |
| task_id | BIGINT PK FK â†’ analysis_tasks.id ON DELETE CASCADE |
| updated_at | TIMESTAMPTZ DEFAULT NOW() |
| fps | FLOAT | è¿‘æœŸè™•ç† FPS |
| person_count | INTEGER | ç•¶å‰åµæ¸¬åˆ°çš„äººæ•¸æˆ–ç¸½é‡ |
| avg_confidence | FLOAT | å¹³å‡ä¿¡å¿ƒåº¦ |
| line_stats / zone_stats / speed_stats | JSONB | å°æ‡‰çµ±è¨ˆè³‡æ–™ |
| extra | JSONB | å…¶ä»–å½ˆæ€§æ¬„ä½ |
ç´¢å¼•ï¼š`idx_task_statistics_updated_at`

ğŸ“Š é—œè¯èˆ‡ä½¿ç”¨æƒ…å¢ƒ
----------------------------------------------------------
1. `data_sources` 1:N `analysis_tasks`ï¼šåŒä¸€ä¾†æºå¯åè¦†å•Ÿå‹•ä»»å‹™ï¼Œä»»å‹™å…§å¯é€é `source_id` æˆ–ä»»å‹™å…§åµŒçš„ camera æ¬„ä½å–å¾—ä¾†æºè³‡è¨Šã€‚
2. `analysis_tasks` 1:N `detection_results`ï¼šé€å¹€æª¢æ¸¬è³‡æ–™ï¼›é€é `tracker_id + frame_timestamp` ä¸²æ¥è¡Œç‚ºäº‹ä»¶èˆ‡ç¸®åœ–ã€‚
3. `analysis_tasks` 1:N (`line_crossing_events` / `zone_dwell_events` / `speed_events`)ï¼šäº‹ä»¶è¨˜éŒ„è¡¨çš†æŒæœ‰ `task_id` èˆ‡ `tracker_id`ï¼Œæ–¹ä¾¿å›æŸ¥åŸå§‹æª¢æ¸¬è³‡æ–™ã€‚
4. `task_statistics` èˆ‡ `analysis_tasks` ç‚º 1:1ï¼Œä¿å­˜æœ€æ–°å³æ™‚çµ±è¨ˆï¼ˆå„€è¡¨æ¿è¼ªè©¢ä½¿ç”¨ï¼‰ã€‚
5. `users` å°šæœªæ¥åˆ°ä»»å‹™ï¼Œä½†è‹¥å•Ÿç”¨å»ºè­°åœ¨ `analysis_tasks` å¢åŠ  `user_id` FKï¼›`system_config` æä¾›å„æ¨¡çµ„å…±äº«çš„é…ç½®ï¼Œä¾‹å¦‚ä»»å‹™åŒæ™‚ä¸Šé™ã€ä¿ç•™å¤©æ•¸ç­‰ã€‚

ğŸ’¡ å¾ŒçºŒå»¶ä¼¸å»ºè­°
----------------------------------------------------------
- è‹¥è¦æ”¯æ´åµæ¸¬ç´€éŒ„æŸ¥è©¢é¡¯ç¤ºç¸®åœ–ï¼ç‰‡æ®µï¼Œå¯åœ¨ `detection_results` æ–°å¢ `thumbnail_path`ã€`clip_path` æˆ–å»ºç«‹ç¨ç«‹çš„ `detection_media` è¡¨ã€‚
- é‡å°å¤§é‡æ­·å²è³‡æ–™ï¼Œå¯è€ƒæ…®å°‡ `detection_results` ä¾ä»»å‹™åˆ†å€ï¼ˆPostgreSQL Partitionï¼‰æˆ–å®šæœŸåŒ¯å‡ºå†·è³‡æ–™ï¼Œé¿å…å–®è¡¨éå¤§ã€‚
