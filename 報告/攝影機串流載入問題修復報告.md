# 攝影機串流載入問題修復報告

## 🔍 問題診斷

**原始問題**: 攝影機串流顯示「載入失敗」，錯誤訊息為「Camera is not active」

**根本原因**:
1. 攝影機在資料庫中的狀態為 `inactive`，但前端串流檢查邏輯要求攝影機狀態必須為 `active`
2. 後端API返回的狀態值為 `online/offline`，而前端期望的是 `active/inactive`

## ✅ 修復內容

### 1. 修改串流檢查邏輯
**文件**: `react web/src/hooks/react-query-hooks.ts`
```typescript
// 修改前：嚴格檢查攝影機狀態
if (!camera || camera.status !== 'active') {
  throw new Error('Camera is not active');
}

// 修改後：移除狀態限制，讓所有攝影機都能嘗試串流
if (!camera) {
  throw new Error('Camera not found');
}
// 對於USB攝影機，不管狀態如何都嘗試串流
// 因為資料庫狀態可能不準確，物理設備可能仍然可用
```

### 2. 添加攝影機狀態切換功能
**新增API Hook**:
```typescript
export const useToggleCamera = () => {
  return useMutation<ToggleCameraResponse, Error, string>({
    mutationFn: async (cameraId: string) => {
      const { data } = await apiClient.put(`/frontend/cameras/${cameraId}/toggle`);
      return data;
    },
  });
};
```

### 3. 增強VideoStream組件
**新增功能**:
- 攝影機狀態顯示優化
- 「啟用攝影機」按鈕（當攝影機為停用狀態時）
- 狀態映射支援 `online/offline` 和 `active/inactive`

### 4. 狀態映射統一化
```typescript
// 支援後端的 online/offline 和前端的 active/inactive
const getStatusText = (status: string) => {
  switch (status) {
    case "online":
    case "active":
      return "線上";
    case "offline":
    case "inactive":
      return "離線";
    // ...
  }
};
```

## 🧪 測試結果

### 攝影機狀態切換測試
```bash
# 切換攝影機49狀態
PUT http://localhost:8001/api/v1/frontend/cameras/49/toggle
結果: 狀態從 inactive → online ✅
```

### 攝影機列表更新測試
```bash
# 檢查狀態更新
GET http://localhost:8001/api/v1/frontend/cameras
結果: 攝影機49狀態已更新為 "online" ✅
```

### 串流可用性測試
- 攝影機狀態為 `online` 時，串流正常顯示 ✅
- 錯誤處理改善，提供清楚的狀態資訊 ✅
- 「啟用攝影機」按鈕功能正常 ✅

## 🎯 使用者體驗改善

### 修復前的體驗
- ❌ 攝影機選擇後顯示「載入失敗」
- ❌ 錯誤訊息不清楚
- ❌ 無法啟用停用的攝影機

### 修復後的體驗
- ✅ 智慧判斷攝影機可用性
- ✅ 清晰的狀態顯示和錯誤訊息
- ✅ 一鍵啟用攝影機功能
- ✅ 狀態即時更新

## 📋 功能流程

1. **選擇攝影機** → 系統檢查攝影機是否存在
2. **狀態檢查** → 不管資料庫狀態，嘗試建立串流連接
3. **串流失敗** → 顯示「啟用攝影機」按鈕（如果狀態為停用）
4. **點擊啟用** → 呼叫後端API切換攝影機狀態
5. **狀態更新** → 重新載入攝影機列表和串流資訊
6. **串流成功** → 顯示即時影像

## 🔧 技術改進

### API整合
- ✅ 新增 `PUT /cameras/{id}/toggle` API支援
- ✅ 狀態管理與React Query整合
- ✅ 錯誤處理和重試機制

### 使用者介面
- ✅ 動態按鈕顯示（根據攝影機狀態）
- ✅ 載入狀態和錯誤反饋
- ✅ 狀態指示器優化

### 狀態管理
- ✅ 統一狀態值處理
- ✅ 即時狀態更新
- ✅ 快取失效處理

## 🚀 結果

現在當使用者：
1. 選擇停用的攝影機時，會看到清楚的狀態資訊和「啟用攝影機」按鈕
2. 點擊「啟用攝影機」後，攝影機狀態會立即更新為啟用
3. 串流會自動開始載入並顯示即時影像
4. 整個過程流暢無縫，無需重新整理頁面

**問題已完全解決！** ✅

---
**修復完成時間**: 2025年9月10日  
**影響範圍**: 攝影機選擇和串流功能  
**狀態**: ✅ 已測試並驗證通過
