<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>攝影機管理 - YOLOv11 系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-bg: #1f2937;
            --card-bg: #374151;
            --border-color: #4b5563;
        }

        body {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            width: 280px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
        }

        .nav-link {
            color: #e0e7ff !important;
            padding: 0.75rem 1.5rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            background: none;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff !important;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff !important;
            font-weight: 600;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: white;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-bottom: 1px solid var(--border-color);
            border-radius: 1rem 1rem 0 0 !important;
            font-weight: 600;
        }

        .camera-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .camera-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .camera-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .status-connecting {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }

        .btn-custom {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .btn-success-custom {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .form-control {
            background: #4b5563;
            border: 1px solid #6b7280;
            color: white;
            border-radius: 0.5rem;
        }

        .form-control:focus {
            background: #4b5563;
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
        }

        .form-select {
            background: #4b5563;
            border: 1px solid #6b7280;
            color: white;
        }

        .camera-preview {
            width: 100%;
            height: 200px;
            background: #1f2937;
            border: 2px dashed #4b5563;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.875rem;
        }

        .camera-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- 側邊欄 -->
    <nav class="sidebar">
        <div class="p-4">
            <div class="d-flex align-items-center mb-4">
                <i class="fas fa-robot fs-3 text-light me-3"></i>
                <div>
                    <h5 class="text-light mb-0">YOLOv11 系統</h5>
                    <small class="text-light opacity-75">新版管理界面</small>
                </div>
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/admin/v2/">
                        <i class="fas fa-tachometer-alt"></i> 主控台
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/v2/tasks">
                        <i class="fas fa-tasks"></i> 任務管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/v2/sources">
                        <i class="fas fa-database"></i> 資料來源管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/v2/config">
                        <i class="fas fa-cogs"></i> 系統配置
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/v2/yolo-config">
                        <i class="fas fa-robot"></i> YOLO模型配置
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/v2/camera-management">
                        <i class="fas fa-video"></i> 攝影機管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/v2/analytics">
                        <i class="fas fa-chart-bar"></i> 分析統計
                    </a>
                </li>
                <li class="nav-item mt-3">
                    <a class="nav-link" href="/admin/">
                        <i class="fas fa-arrow-left"></i> 舊版後台
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/docs">
                        <i class="fas fa-book"></i> API 文檔
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-light mb-2">攝影機管理</h1>
                <p class="text-muted mb-0">管理內建/外接攝影機連接與配置</p>
            </div>
            <div>
                <button class="btn btn-primary-custom btn-custom me-2" onclick="scanCameras()">
                    <i class="fas fa-search me-2"></i>掃描攝影機
                </button>
                <button class="btn btn-success-custom btn-custom" onclick="addCamera()">
                    <i class="fas fa-plus me-2"></i>新增攝影機
                </button>
            </div>
        </div>

        <!-- 統計資訊 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value text-success" id="onlineCameras">0</div>
                <div class="stat-label">線上攝影機</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-danger" id="offlineCameras">0</div>
                <div class="stat-label">離線攝影機</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-info" id="totalCameras">0</div>
                <div class="stat-label">總攝影機數</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-warning" id="activeTasks">0</div>
                <div class="stat-label">使用中任務</div>
            </div>
        </div>

        <!-- 攝影機列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-video me-2"></i>攝影機設備列表
                </h5>
            </div>
            <div class="card-body">
                <div id="cameraList" class="row">
                    <!-- 攝影機卡片將由 JavaScript 動態生成 -->
                    <div class="col-12 text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-video fs-1 mb-3"></i>
                            <p>點擊「掃描攝影機」來搜尋可用的攝影機設備</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 攝影機配置 Modal -->
        <div class="modal fade" id="cameraConfigModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: var(--card-bg); color: white;">
                    <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                        <h5 class="modal-title">
                            <i class="fas fa-cog me-2"></i>攝影機配置
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="cameraConfigForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">攝影機名稱</label>
                                    <input type="text" class="form-control" id="cameraName" placeholder="例：前門攝影機">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">攝影機類型</label>
                                    <select class="form-select" id="cameraType">
                                        <option value="usb">USB 攝影機</option>
                                        <option value="ip">網路攝影機</option>
                                        <option value="rtsp">RTSP 串流</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">設備索引/URL</label>
                                    <input type="text" class="form-control" id="cameraSource" placeholder="0 或 rtsp://...">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">解析度</label>
                                    <select class="form-select" id="cameraResolution">
                                        <option value="640x480">640x480</option>
                                        <option value="1280x720">1280x720 (HD)</option>
                                        <option value="1920x1080">1920x1080 (Full HD)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">幀率 (FPS)</label>
                                    <input type="number" class="form-control" id="cameraFps" value="30" min="1" max="60">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">緩衝區大小</label>
                                    <input type="number" class="form-control" id="cameraBuffer" value="1" min="1" max="10">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" id="cameraDescription" rows="2" placeholder="攝影機描述（可選）"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">預覽</label>
                                <div class="camera-preview" id="cameraPreview">
                                    <i class="fas fa-eye-slash me-2"></i>攝影機預覽將在此顯示
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary-custom btn-custom" onclick="testCamera()">
                            <i class="fas fa-play me-2"></i>測試攝影機
                        </button>
                        <button type="button" class="btn btn-success-custom btn-custom" onclick="saveCamera()">
                            <i class="fas fa-save me-2"></i>儲存配置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cameras = [];
        let editingCameraId = null;

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCameras();
            updateStats();
        });

        // 掃描攝影機
        async function scanCameras() {
            const scanBtn = document.querySelector('[onclick="scanCameras()"]');
            const originalText = scanBtn.innerHTML;
            scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>掃描中...';
            scanBtn.disabled = true;

            try {
                const response = await fetch('/admin/v2/api/cameras/scan');
                const data = await response.json();
                
                if (data.success && data.data.cameras) {
                    cameras = data.data.cameras;
                    renderCameras();
                    updateStats();
                    showNotification('掃描完成，找到 ' + data.data.cameras.length + ' 個攝影機', 'success');
                } else {
                    showNotification('掃描失敗：' + (data.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                showNotification('掃描失敗：' + error.message, 'error');
            } finally {
                scanBtn.innerHTML = originalText;
                scanBtn.disabled = false;
            }
        }

        // 載入已配置的攝影機
        async function loadCameras() {
            try {
                const response = await fetch('/admin/v2/api/cameras');
                const data = await response.json();
                
                if (data.success && data.data.cameras) {
                    cameras = data.data.cameras;
                    renderCameras();
                    updateStats();
                }
            } catch (error) {
                console.error('載入攝影機列表失敗:', error);
            }
        }

        // 渲染攝影機列表
        function renderCameras() {
            const container = document.getElementById('cameraList');
            
            if (cameras.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-video fs-1 mb-3"></i>
                            <p>點擊「掃描攝影機」來搜尋可用的攝影機設備</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = cameras.map(camera => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="camera-card p-3">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="text-light mb-1">${camera.name || '攝影機 ' + camera.index}</h6>
                                <small class="text-muted">${camera.type || 'USB'} - ${camera.resolution || '未知解析度'}</small>
                            </div>
                            <span class="camera-status ${getStatusClass(camera.status)}">
                                ${getStatusText(camera.status)}
                            </span>
                        </div>
                        
                        <div class="camera-preview mb-3" style="height: 120px;">
                            ${camera.preview_url ? 
                                `<img src="${camera.preview_url}" class="img-fluid rounded" style="max-height: 100%;">` :
                                '<i class="fas fa-video me-2"></i>無預覽'
                            }
                        </div>
                        
                        <div class="camera-actions">
                            <button class="btn btn-sm btn-primary-custom" onclick="editCamera(${camera.id || camera.index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-success-custom" onclick="testCamera(${camera.id || camera.index})">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-danger-custom" onclick="deleteCamera(${camera.id || camera.index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 獲取狀態樣式類別
        function getStatusClass(status) {
            switch (status) {
                case 'online': return 'status-online';
                case 'offline': return 'status-offline';
                case 'connecting': return 'status-connecting';
                default: return 'status-offline';
            }
        }

        // 獲取狀態文字
        function getStatusText(status) {
            switch (status) {
                case 'online': return '線上';
                case 'offline': return '離線';
                case 'connecting': return '連接中';
                default: return '未知';
            }
        }

        // 更新統計資訊
        function updateStats() {
            const online = cameras.filter(c => c.status === 'online').length;
            const offline = cameras.filter(c => c.status === 'offline').length;
            const total = cameras.length;
            
            document.getElementById('onlineCameras').textContent = online;
            document.getElementById('offlineCameras').textContent = offline;
            document.getElementById('totalCameras').textContent = total;
            // activeTasks 需要從其他 API 獲取
        }

        // 新增攝影機
        function addCamera() {
            editingCameraId = null;
            document.getElementById('cameraConfigForm').reset();
            document.getElementById('cameraSource').placeholder = '0';
            new bootstrap.Modal(document.getElementById('cameraConfigModal')).show();
        }

        // 編輯攝影機
        function editCamera(cameraId) {
            const camera = cameras.find(c => (c.id || c.index) == cameraId);
            if (!camera) return;

            editingCameraId = cameraId;
            document.getElementById('cameraName').value = camera.name || '';
            document.getElementById('cameraType').value = camera.type || 'usb';
            document.getElementById('cameraSource').value = camera.source || camera.index || '';
            document.getElementById('cameraResolution').value = camera.resolution || '1280x720';
            document.getElementById('cameraFps').value = camera.fps || 30;
            document.getElementById('cameraBuffer').value = camera.buffer || 1;
            document.getElementById('cameraDescription').value = camera.description || '';
            
            new bootstrap.Modal(document.getElementById('cameraConfigModal')).show();
        }

        // 測試攝影機
        async function testCamera(cameraId) {
            if (cameraId === undefined) {
                // 從表單測試
                const source = document.getElementById('cameraSource').value;
                if (!source) {
                    showNotification('請輸入攝影機來源', 'warning');
                    return;
                }
                // 實現測試邏輯
                showNotification('測試功能開發中...', 'info');
            } else {
                // 測試現有攝影機
                showNotification('測試功能開發中...', 'info');
            }
        }

        // 儲存攝影機配置
        async function saveCamera() {
            const formData = {
                name: document.getElementById('cameraName').value,
                type: document.getElementById('cameraType').value,
                source: document.getElementById('cameraSource').value,
                resolution: document.getElementById('cameraResolution').value,
                fps: parseInt(document.getElementById('cameraFps').value),
                buffer: parseInt(document.getElementById('cameraBuffer').value),
                description: document.getElementById('cameraDescription').value
            };

            if (!formData.name || !formData.source) {
                showNotification('請填寫攝影機名稱和來源', 'warning');
                return;
            }

            try {
                const url = editingCameraId ? 
                    `/admin/v2/api/cameras/${editingCameraId}` : 
                    '/admin/v2/api/cameras';
                
                const method = editingCameraId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification(editingCameraId ? '攝影機更新成功' : '攝影機新增成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('cameraConfigModal')).hide();
                    loadCameras();
                } else {
                    showNotification('操作失敗：' + (data.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                showNotification('操作失敗：' + error.message, 'error');
            }
        }

        // 刪除攝影機
        async function deleteCamera(cameraId) {
            if (!confirm('確定要刪除這個攝影機配置嗎？')) {
                return;
            }

            try {
                const response = await fetch(`/admin/v2/api/cameras/${cameraId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification('攝影機刪除成功', 'success');
                    loadCameras();
                } else {
                    showNotification('刪除失敗：' + (data.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                showNotification('刪除失敗：' + error.message, 'error');
            }
        }

        // 顯示通知
        function showNotification(message, type = 'info') {
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} position-fixed top-0 end-0 m-3`;
            notification.style.zIndex = '9999';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
