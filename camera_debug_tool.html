<!DOCTYPE html>
<html>
<head>
    <title>YOLOv11 攝影機系統調試工具</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #1f2937;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            border: 2px solid #4f46e5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #374151;
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4338ca; }
        .result {
            background: #1f2937;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YOLOv11 攝影機系統調試工具</h1>
        
        <div class="test-section info">
            <h2>基本連接測試</h2>
            <button onclick="testHealth()">健康檢查</button>
            <button onclick="testCameras()">攝影機列表</button>
            <button onclick="testStream()">串流測試</button>
            <div id="basic-results" class="result"></div>
        </div>

        <div class="test-section info">
            <h2>攝影機操作測試</h2>
            <button onclick="testToggleCamera()">切換攝影機狀態</button>
            <button onclick="testCameraScan()">掃描攝影機</button>
            <div id="camera-results" class="result"></div>
        </div>

        <div class="test-section info">
            <h2>React Query Hook 測試</h2>
            <button onclick="testReactQueryAPI()">模擬前端API調用</button>
            <div id="query-results" class="result"></div>
        </div>

        <div class="test-section info">
            <h2>串流顯示測試</h2>
            <div>
                <p>即時串流測試:</p>
                <img 
                    id="stream-test"
                    src="http://localhost:8001/api/v1/frontend/cameras/0/stream"
                    alt="攝影機串流測試"
                    style="max-width: 400px; border: 1px solid #6b7280;"
                    onload="logResult('stream-display', '串流圖片載入成功')"
                    onerror="logResult('stream-display', '串流圖片載入失敗: ' + this.src)"
                />
            </div>
            <div id="stream-display" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api/v1';
        
        function logResult(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            console.log(`[${timestamp}] ${message}`);
        }

        async function testHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                logResult('basic-results', `健康檢查: ${data.status} - ${JSON.stringify(data.basic_info, null, 2)}`);
            } catch (error) {
                logResult('basic-results', `健康檢查失敗: ${error.message}`);
            }
        }

        async function testCameras() {
            try {
                const response = await fetch(`${API_BASE}/frontend/cameras`);
                const data = await response.json();
                logResult('basic-results', `攝影機列表: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                logResult('basic-results', `攝影機列表獲取失敗: ${error.message}`);
            }
        }

        async function testStream() {
            try {
                const response = await fetch(`${API_BASE}/frontend/cameras/0/stream`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                logResult('basic-results', `串流測試: Status ${response.status}, Content-Type: ${response.headers.get('content-type')}`);
            } catch (error) {
                logResult('basic-results', `串流測試失敗: ${error.message}`);
            }
        }

        async function testToggleCamera() {
            try {
                const response = await fetch(`${API_BASE}/frontend/cameras/49/toggle`, {
                    method: 'PUT'
                });
                const data = await response.json();
                logResult('camera-results', `攝影機切換: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                logResult('camera-results', `攝影機切換失敗: ${error.message}`);
            }
        }

        async function testCameraScan() {
            try {
                const response = await fetch(`${API_BASE}/cameras/scan`);
                const data = await response.json();
                logResult('camera-results', `攝影機掃描: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                logResult('camera-results', `攝影機掃描失敗: ${error.message}`);
            }
        }

        async function testReactQueryAPI() {
            try {
                // 測試前端會使用的API模式
                const cameras = await fetch(`${API_BASE}/frontend/cameras`);
                const camerasData = await cameras.json();
                
                if (camerasData.length > 0) {
                    const camera = camerasData[0];
                    logResult('query-results', `找到攝影機: ID=${camera.id}, Status=${camera.status}, Type=${camera.camera_type}`);
                    
                    // 測試串流資訊構建邏輯 (模擬前端hook)
                    if (camera.camera_type === 'USB') {
                        const cameraIndex = camera.device_index !== undefined ? camera.device_index : 0;
                        const streamUrl = `/api/v1/frontend/cameras/${cameraIndex}/stream`;
                        logResult('query-results', `串流URL構建: ${streamUrl}`);
                        
                        // 測試這個URL
                        try {
                            const streamTest = await fetch(`${API_BASE}/frontend/cameras/${cameraIndex}/stream`, {
                                method: 'GET',
                                signal: AbortSignal.timeout(2000)
                            });
                            logResult('query-results', `串流URL測試: ${streamTest.status} ${streamTest.statusText}`);
                        } catch (streamError) {
                            logResult('query-results', `串流URL測試失敗: ${streamError.message}`);
                        }
                    }
                } else {
                    logResult('query-results', '沒有找到攝影機');
                }
            } catch (error) {
                logResult('query-results', `React Query 測試失敗: ${error.message}`);
            }
        }

        // 自動執行基本測試
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testHealth();
                testCameras();
            }, 1000);
        });
    </script>
</body>
</html>
