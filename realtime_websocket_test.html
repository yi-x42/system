<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦æ™‚æª¢æ¸¬ WebSocket æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected { background-color: #d4edda; color: #155724; }
        .status.disconnected { background-color: #f8d7da; color: #721c24; }
        .status.detecting { background-color: #fff3cd; color: #856404; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .detection-result {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 5px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ å¯¦æ™‚æª¢æ¸¬ WebSocket æ¸¬è©¦ä»‹é¢</h1>
    
    <div class="grid">
        <div class="container">
            <h2>ğŸ”— WebSocket é€£æ¥</h2>
            <div id="connectionStatus" class="status disconnected">æœªé€£æ¥</div>
            <button id="connectBtn" class="button btn-primary">é€£æ¥ WebSocket</button>
            <button id="disconnectBtn" class="button btn-danger">æ–·é–‹é€£æ¥</button>
            
            <h3>ğŸ“¹ å¯¦æ™‚æª¢æ¸¬æ§åˆ¶</h3>
            <label>æ”å½±æ©Ÿç´¢å¼•ï¼š</label>
            <input type="number" id="cameraIndex" value="0" min="0" max="10">
            <br>
            <button id="startDetectionBtn" class="button btn-success">å•Ÿå‹•å¯¦æ™‚æª¢æ¸¬</button>
            <button id="stopDetectionBtn" class="button btn-warning">åœæ­¢æª¢æ¸¬</button>
            <button id="statusBtn" class="button btn-primary">æª¢æŸ¥ç‹€æ…‹</button>
        </div>
        
        <div class="container">
            <h2>ğŸ“Š æª¢æ¸¬ç‹€æ…‹</h2>
            <div id="detectionStatus" class="status disconnected">æœªæª¢æ¸¬</div>
            <div id="stats">
                <p>æª¢æ¸¬æ¬¡æ•¸: <span id="detectionCount">0</span></p>
                <p>æœ€å¾Œæª¢æ¸¬æ™‚é–“: <span id="lastDetection">ç„¡</span></p>
                <p>WebSocket è¨Šæ¯æ•¸: <span id="messageCount">0</span></p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>ğŸ“ æ—¥èªŒ</h2>
        <button id="clearLogBtn" class="button btn-warning">æ¸…ç©ºæ—¥èªŒ</button>
        <div id="log" class="log"></div>
    </div>
    
    <div class="container">
        <h2>ğŸ¯ æœ€æ–°æª¢æ¸¬çµæœ</h2>
        <div id="latestResult" class="detection-result">
            <p>ç­‰å¾…æª¢æ¸¬çµæœ...</p>
        </div>
    </div>

    <script>
        let ws = null;
        let detectionCount = 0;
        let messageCount = 0;
        
        const API_BASE = 'http://26.86.64.166:8001/api/v1';
        const WS_URL = 'ws://26.86.64.166:8001/ws/detection';
        
        // DOM å…ƒç´ 
        const connectionStatus = document.getElementById('connectionStatus');
        const detectionStatus = document.getElementById('detectionStatus');
        const log = document.getElementById('log');
        const detectionCountSpan = document.getElementById('detectionCount');
        const lastDetectionSpan = document.getElementById('lastDetection');
        const messageCountSpan = document.getElementById('messageCount');
        const latestResult = document.getElementById('latestResult');
        
        // æ—¥èªŒå‡½æ•¸
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            if (type === 'error') logEntry.style.color = '#dc3545';
            if (type === 'success') logEntry.style.color = '#28a745';
            if (type === 'warning') logEntry.style.color = '#ffc107';
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        // WebSocket é€£æ¥
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('WebSocket å·²ç¶“é€£æ¥', 'warning');
                return;
            }
            
            addLog('æ­£åœ¨é€£æ¥ WebSocket...');
            ws = new WebSocket(WS_URL);
            
            ws.onopen = function() {
                addLog('WebSocket é€£æ¥æˆåŠŸï¼', 'success');
                connectionStatus.textContent = 'å·²é€£æ¥';
                connectionStatus.className = 'status connected';
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                messageCountSpan.textContent = messageCount;
                
                try {
                    const data = JSON.parse(event.data);
                    addLog(`æ”¶åˆ°è¨Šæ¯: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    if (data.type === 'detection_result') {
                        detectionCount++;
                        detectionCountSpan.textContent = detectionCount;
                        lastDetectionSpan.textContent = new Date().toLocaleTimeString();
                        
                        // æ›´æ–°æœ€æ–°æª¢æ¸¬çµæœ
                        latestResult.innerHTML = `
                            <h4>æª¢æ¸¬çµæœ #${detectionCount}</h4>
                            <p><strong>ä»»å‹™ID:</strong> ${data.task_id}</p>
                            <p><strong>æ”å½±æ©Ÿ:</strong> ${data.camera_index}</p>
                            <p><strong>æª¢æ¸¬ç‰©ä»¶æ•¸é‡:</strong> ${data.detections ? data.detections.length : 0}</p>
                            <p><strong>æ™‚é–“:</strong> ${data.timestamp}</p>
                            ${data.detections && data.detections.length > 0 ? 
                                '<p><strong>æª¢æ¸¬åˆ°çš„ç‰©ä»¶:</strong> ' + 
                                data.detections.map(d => `${d.class_name} (ä¿¡å¿ƒåº¦: ${d.confidence})`).join(', ') + 
                                '</p>' : '<p>æœªæª¢æ¸¬åˆ°ç‰©ä»¶</p>'
                            }
                        `;
                    }
                } catch (e) {
                    addLog(`è§£æè¨Šæ¯å¤±æ•—: ${e.message}`, 'error');
                }
            };
            
            ws.onclose = function() {
                addLog('WebSocket é€£æ¥å·²æ–·é–‹', 'warning');
                connectionStatus.textContent = 'æœªé€£æ¥';
                connectionStatus.className = 'status disconnected';
            };
            
            ws.onerror = function(error) {
                addLog(`WebSocket éŒ¯èª¤: ${error}`, 'error');
            };
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                addLog('æ‰‹å‹•æ–·é–‹ WebSocket é€£æ¥');
            }
        }
        
        // API èª¿ç”¨
        async function apiCall(url, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`API èª¿ç”¨æˆåŠŸ: ${method} ${url}`, 'success');
                    addLog(`å›æ‡‰: ${JSON.stringify(data, null, 2)}`);
                    return data;
                } else {
                    addLog(`API èª¿ç”¨å¤±æ•—: ${response.status} - ${JSON.stringify(data)}`, 'error');
                    return null;
                }
            } catch (error) {
                addLog(`API èª¿ç”¨éŒ¯èª¤: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function startDetection() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            const result = await apiCall(`${API_BASE}/realtime/start/${cameraIndex}`, 'POST');
            
            if (result) {
                detectionStatus.textContent = 'æª¢æ¸¬ä¸­';
                detectionStatus.className = 'status detecting';
                addLog(`å¯¦æ™‚æª¢æ¸¬å·²å•Ÿå‹•ï¼Œä»»å‹™ID: ${result.task_id}`, 'success');
            }
        }
        
        async function stopDetection() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            const result = await apiCall(`${API_BASE}/realtime/stop/${cameraIndex}`, 'POST');
            
            if (result) {
                detectionStatus.textContent = 'å·²åœæ­¢';
                detectionStatus.className = 'status disconnected';
                addLog(`å¯¦æ™‚æª¢æ¸¬å·²åœæ­¢ï¼Œç¸½æª¢æ¸¬æ•¸: ${result.total_detections}`, 'success');
            }
        }
        
        async function checkStatus() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            const result = await apiCall(`${API_BASE}/realtime/status/${cameraIndex}`);
            
            if (result) {
                if (result.running) {
                    detectionStatus.textContent = 'æª¢æ¸¬ä¸­';
                    detectionStatus.className = 'status detecting';
                } else {
                    detectionStatus.textContent = 'æœªæª¢æ¸¬';
                    detectionStatus.className = 'status disconnected';
                }
                
                addLog(`æª¢æ¸¬ç‹€æ…‹: ${result.running ? 'é‹è¡Œä¸­' : 'æœªé‹è¡Œ'}`, 'info');
                if (result.running) {
                    addLog(`ä»»å‹™ID: ${result.task_id}, æª¢æ¸¬æ•¸é‡: ${result.detection_count}`);
                }
            }
        }
        
        function clearLog() {
            log.innerHTML = '';
            addLog('æ—¥èªŒå·²æ¸…ç©º');
        }
        
        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('connectBtn').addEventListener('click', connectWebSocket);
        document.getElementById('disconnectBtn').addEventListener('click', disconnectWebSocket);
        document.getElementById('startDetectionBtn').addEventListener('click', startDetection);
        document.getElementById('stopDetectionBtn').addEventListener('click', stopDetection);
        document.getElementById('statusBtn').addEventListener('click', checkStatus);
        document.getElementById('clearLogBtn').addEventListener('click', clearLog);
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        addLog('é é¢å·²è¼‰å…¥ï¼Œæº–å‚™é–‹å§‹æ¸¬è©¦');
        addLog(`API åŸºç¤åœ°å€: ${API_BASE}`);
        addLog(`WebSocket åœ°å€: ${WS_URL}`);
    </script>
</body>
</html>
