# YOLOv11 數位雙生分析系統 - 業務規則定義

## 物件偵測規則

### 1. 信心值閾值規則
- 預設信心值閾值: 0.5
- 高精度模式閾值: 0.7
- 快速偵測模式閾值: 0.3
- 動態調整: 根據場景複雜度自動調整

### 2. 物件過濾規則
- 最小邊界框面積: 100 像素
- 最大邊界框面積: 圖片面積的 80%
- 邊界框長寬比限制: 0.1 - 10.0
- 重疊度過濾: IOU > 0.45 的重疊物件

## 追蹤規則

### 1. 追蹤器選擇規則
- 人員追蹤: ByteTrack (精度優先)
- 車輛追蹤: BoT-SORT (速度優先)
- 小物件追蹤: ByteTrack + 低閾值
- 密集場景: BoT-SORT + 高閾值

### 2. 追蹤生命週期規則
- 新追蹤建立: 連續 3 幀出現
- 追蹤消失: 連續 30 幀未出現
- 追蹤重新連結: 5 幀內重新出現
- 最大追蹤數量: 100 個

### 3. 追蹤品質規則
- 最低追蹤信心值: 0.3
- 追蹤穩定性閾值: 5 幀
- 軌跡平滑化: 卡爾曼濾波
- 速度異常檢測: 超過正常速度 3 倍

## 異常事件規則

### 1. 停留時間異常
- 正常停留時間: < 5 分鐘
- 異常停留時間: 5-10 分鐘 (中等警告)
- 長時間停留: > 10 分鐘 (高級警告)
- 區域特殊規則: VIP 區域停留 > 2 分鐘即警告

### 2. 區域入侵規則
- 禁止區域: 立即觸發警告
- 限制區域: 停留 > 30 秒觸發警告
- 敏感區域: 記錄但不警告
- 時間限制: 夜間 (22:00-06:00) 任何區域入侵都警告

### 3. 人流密度規則
- 正常密度: < 5 人/平方米
- 擁擠警告: 5-8 人/平方米
- 危險密度: > 8 人/平方米
- 緊急疏散: > 10 人/平方米

### 4. 物品遺留規則
- 小物品 (背包、手提袋): 遺留 > 10 分鐘警告
- 大物品 (行李箱): 遺留 > 5 分鐘警告
- 危險物品 (可疑包裹): 立即警告
- 區域限制: 安檢區域任何遺留物品立即警告

### 5. 行為異常規則
- 逆向行走: 與人流方向相反 > 3 秒
- 徘徊行為: 在同一區域重複出現 > 5 次
- 快速移動: 速度超過正常行走速度 2 倍
- 聚集行為: 5 人以上聚集 > 2 分鐘

## 計數規則

### 1. 進出計數規則
- 計數線位置: 門口中央垂直線
- 計數方向: 根據重心穿越方向判定
- 重複計數防護: 同一 track_id 在 3 秒內只計數一次
- 誤計數修正: 短時間內來回穿越不計數

### 2. 區域計數規則
- 區域進入: 重心完全進入區域邊界
- 區域離開: 重心完全離開區域邊界
- 停留時間: 從進入到離開的總時間
- 同時在場人數: 當前在區域內的總人數

## 熱點圖規則

### 1. 熱點計算規則
- 時間窗口: 5 分鐘滑動窗口
- 網格大小: 1024x1024
- 高斯核: 標準差 2.0 像素
- 更新頻率: 每 30 秒更新一次

### 2. 熱點強度規則
- 強度計算: 基於停留時間 × 人數
- 正規化範圍: 0.0 - 1.0
- 顏色映射: 藍(冷) → 綠 → 黃 → 紅(熱)
- 閾值設定: > 0.7 為高熱點區域

## Unity 同步規則

### 1. 數據同步規則
- 同步頻率: 30 FPS (實時)
- 數據格式: JSON (標準) / ProtoBuf (高效)
- 坐標轉換: 像素坐標 → 世界坐標
- 比例因子: 可配置的像素/米比例

### 2. 物件映射規則
- Track ID 映射: track_id ↔ Unity GameObject ID
- 類別映射: YOLO 類別 ↔ Unity Prefab
- 位置映射: 邊界框中心 ↔ GameObject.transform.position
- 旋轉映射: 移動方向 ↔ GameObject.transform.rotation

### 3. 效能優化規則
- 距離剔除: 超出視野範圍的物件不同步
- 低信心過濾: 信心值 < 0.5 的物件不同步
- 批次更新: 每幀最多同步 50 個物件
- 差量更新: 只同步有變化的物件

## 系統效能規則

### 1. GPU 使用規則
- GPU 記憶體限制: 不超過總記憶體的 80%
- 批次大小: 根據 GPU 記憶體動態調整
- 記憶體清理: 每 100 次推論後清理一次
- 降級策略: GPU 不足時自動切換到 CPU

### 2. CPU 使用規則
- CPU 使用率: 不超過 90%
- 線程池大小: CPU 核心數 × 2
- 工作進程數: 根據負載動態調整
- 優先級分配: 推論 > 追蹤 > 分析 > 同步

### 3. 記憶體管理規則
- 記憶體使用限制: 不超過系統記憶體的 70%
- 圖片快取: 最近 100 張圖片
- 結果快取: 最近 1000 個結果
- 垃圾回收: 每小時強制 GC 一次

## 安全與隱私規則

### 1. 數據保護規則
- 圖片存儲: 最多保存 24 小時
- 人臉模糊: 自動檢測並模糊人臉區域
- 敏感區域: 特定區域不進行錄影或分析
- 用戶同意: 需要明確的使用者同意

### 2. 存取控制規則
- 角色權限: 管理員 > 操作員 > 檢視者
- API 限流: 每分鐘最多 100 次請求
- JWT 過期: 30 分鐘無操作自動過期
- IP 白名單: 只允許特定 IP 存取

## 異常處理規則

### 1. 錯誤恢復規則
- 模型載入失敗: 自動重試 3 次
- 推論錯誤: 跳過當前幀，繼續處理
- 網路中斷: 本地快取，恢復後同步
- 資料庫錯誤: 降級到檔案存儲

### 2. 告警規則
- 系統錯誤: 立即發送警告
- 效能下降: 超過閾值 5 分鐘後警告
- 服務離線: 立即通知管理員
- 磁碟空間: 使用率 > 90% 警告

## 配置更新規則

### 1. 動態配置規則
- 熱更新支援: 閾值、規則可即時更新
- 配置驗證: 更新前驗證配置有效性
- 回滾機制: 配置錯誤時自動回滾
- 版本控制: 保留最近 10 個配置版本

### 2. 部署規則
- 藍綠部署: 確保服務不中斷
- 健康檢查: 部署後自動驗證服務狀態
- 監控告警: 部署過程中的異常監控
- 回滾策略: 發現問題立即回滾到穩定版本