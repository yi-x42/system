<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時檢測測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        .status.connected { background: rgba(40, 167, 69, 0.8); }
        .status.disconnected { background: rgba(220, 53, 69, 0.8); }
        .status.detecting { background: rgba(255, 193, 7, 0.8); color: black; }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .detection-result {
            background: rgba(0, 123, 255, 0.2);
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ffc107;
        }
        input {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: black;
        }
    </style>
</head>
<body>
    <h1>🎯 YOLOv11 即時檢測系統</h1>
    
    <div class="grid">
        <div class="container">
            <h2>🔗 WebSocket 連接</h2>
            <div id="connectionStatus" class="status disconnected">未連接</div>
            <button id="connectBtn" class="button btn-primary">連接 WebSocket</button>
            <button id="disconnectBtn" class="button btn-danger">斷開連接</button>
            
            <h3>📹 即時檢測控制</h3>
            <label>攝影機索引：</label>
            <input type="number" id="cameraIndex" value="0" min="0" max="10">
            <br><br>
            <button id="startDetectionBtn" class="button btn-success">🚀 啟動即時檢測</button>
            <button id="stopDetectionBtn" class="button btn-warning">⏹️ 停止檢測</button>
            <button id="statusBtn" class="button btn-primary">📊 檢查狀態</button>
        </div>
        
        <div class="container">
            <h2>📊 檢測狀態</h2>
            <div id="detectionStatus" class="status disconnected">未檢測</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="detectionCount">0</div>
                    <div>檢測次數</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="messageCount">0</div>
                    <div>WebSocket 訊息</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="objectCount">0</div>
                    <div>檢測物件總數</div>
                </div>
            </div>
            <p><strong>最後檢測時間：</strong> <span id="lastDetection">無</span></p>
        </div>
    </div>
    
    <div class="container">
        <h2>📝 系統日誌</h2>
        <button id="clearLogBtn" class="button btn-warning">清空日誌</button>
        <div id="log" class="log"></div>
    </div>
    
    <div class="container">
        <h2>🎯 最新檢測結果</h2>
        <div id="latestResult" class="detection-result">
            <p>🔍 等待檢測結果...</p>
        </div>
    </div>

    <script>
        let ws = null;
        let detectionCount = 0;
        let messageCount = 0;
        let objectCount = 0;
        
        const API_BASE = 'http://26.86.64.166:8001/api/v1';
        const WS_URL = 'ws://26.86.64.166:8001/ws/detection';
        
        // DOM 元素
        const connectionStatus = document.getElementById('connectionStatus');
        const detectionStatus = document.getElementById('detectionStatus');
        const log = document.getElementById('log');
        const detectionCountSpan = document.getElementById('detectionCount');
        const lastDetectionSpan = document.getElementById('lastDetection');
        const messageCountSpan = document.getElementById('messageCount');
        const objectCountSpan = document.getElementById('objectCount');
        const latestResult = document.getElementById('latestResult');
        
        // 日誌函數
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #aaa;">[${timestamp}]</span> ${message}`;
            if (type === 'error') logEntry.style.color = '#ff6b6b';
            if (type === 'success') logEntry.style.color = '#51cf66';
            if (type === 'warning') logEntry.style.color = '#ffd43b';
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        // WebSocket 連接
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('⚠️ WebSocket 已經連接', 'warning');
                return;
            }
            
            addLog('🔄 正在連接 WebSocket...');
            ws = new WebSocket(WS_URL);
            
            ws.onopen = function() {
                addLog('✅ WebSocket 連接成功！', 'success');
                connectionStatus.textContent = '已連接';
                connectionStatus.className = 'status connected';
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                messageCountSpan.textContent = messageCount;
                
                try {
                    const data = JSON.parse(event.data);
                    addLog(`📨 收到訊息: ${data.type}`, 'success');
                    
                    if (data.type === 'detection_result') {
                        detectionCount++;
                        detectionCountSpan.textContent = detectionCount;
                        lastDetectionSpan.textContent = new Date().toLocaleTimeString();
                        
                        // 統計檢測到的物件數量
                        if (data.detections) {
                            objectCount += data.detections.length;
                            objectCountSpan.textContent = objectCount;
                        }
                        
                        // 更新最新檢測結果
                        const objectsDetected = data.detections ? data.detections.length : 0;
                        latestResult.innerHTML = `
                            <h4>🎯 檢測結果 #${detectionCount}</h4>
                            <p><strong>📋 任務ID:</strong> ${data.task_id}</p>
                            <p><strong>📹 攝影機:</strong> ${data.camera_index}</p>
                            <p><strong>🔢 檢測物件數:</strong> ${objectsDetected}</p>
                            <p><strong>⏰ 時間:</strong> ${data.timestamp}</p>
                            ${data.detections && data.detections.length > 0 ? 
                                '<p><strong>🎯 檢測到的物件:</strong><br>' + 
                                data.detections.map(d => 
                                    `&nbsp;&nbsp;&nbsp;&nbsp;• ${d.class_name} (信心度: ${(d.confidence * 100).toFixed(1)}%)`
                                ).join('<br>') + 
                                '</p>' : '<p>❌ 未檢測到物件</p>'
                            }
                        `;
                        
                        // 記錄檢測詳情
                        if (data.detections && data.detections.length > 0) {
                            addLog(`🎯 檢測到 ${data.detections.length} 個物件: ${data.detections.map(d => d.class_name).join(', ')}`, 'success');
                        }
                    }
                } catch (e) {
                    addLog(`❌ 解析訊息失敗: ${e.message}`, 'error');
                }
            };
            
            ws.onclose = function() {
                addLog('🔌 WebSocket 連接已斷開', 'warning');
                connectionStatus.textContent = '未連接';
                connectionStatus.className = 'status disconnected';
            };
            
            ws.onerror = function(error) {
                addLog(`❌ WebSocket 錯誤: ${error}`, 'error');
            };
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                addLog('🔌 手動斷開 WebSocket 連接');
            }
        }
        
        // API 調用
        async function apiCall(url, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                addLog(`🔄 API 調用: ${method} ${url.replace(API_BASE, '')}`);
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`✅ API 調用成功`, 'success');
                    console.log('API 回應:', data);
                    return data;
                } else {
                    addLog(`❌ API 調用失敗: ${response.status} - ${JSON.stringify(data)}`, 'error');
                    return null;
                }
            } catch (error) {
                addLog(`❌ API 調用錯誤: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function startDetection() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            addLog(`🚀 正在啟動攝影機 ${cameraIndex} 的即時檢測...`);
            const result = await apiCall(`${API_BASE}/realtime/start/${cameraIndex}`, 'POST');
            
            if (result) {
                detectionStatus.textContent = '檢測中';
                detectionStatus.className = 'status detecting';
                addLog(`✅ 即時檢測已啟動，任務ID: ${result.task_id}`, 'success');
            }
        }
        
        async function stopDetection() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            addLog(`⏹️ 正在停止攝影機 ${cameraIndex} 的即時檢測...`);
            const result = await apiCall(`${API_BASE}/realtime/stop/${cameraIndex}`, 'POST');
            
            if (result) {
                detectionStatus.textContent = '已停止';
                detectionStatus.className = 'status disconnected';
                addLog(`✅ 即時檢測已停止，總檢測數: ${result.total_detections}`, 'success');
            }
        }
        
        async function checkStatus() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            addLog(`📊 檢查攝影機 ${cameraIndex} 的檢測狀態...`);
            const result = await apiCall(`${API_BASE}/realtime/status/${cameraIndex}`);
            
            if (result) {
                if (result.running) {
                    detectionStatus.textContent = '檢測中';
                    detectionStatus.className = 'status detecting';
                    addLog(`✅ 檢測狀態: 運行中`, 'success');
                    addLog(`📋 任務ID: ${result.task_id}, 檢測數量: ${result.detection_count}`);
                } else {
                    detectionStatus.textContent = '未檢測';
                    detectionStatus.className = 'status disconnected';
                    addLog(`ℹ️ 檢測狀態: 未運行`, 'info');
                }
            }
        }
        
        function clearLog() {
            log.innerHTML = '';
            addLog('🧹 日誌已清空');
        }
        
        // 事件監聽器
        document.getElementById('connectBtn').addEventListener('click', connectWebSocket);
        document.getElementById('disconnectBtn').addEventListener('click', disconnectWebSocket);
        document.getElementById('startDetectionBtn').addEventListener('click', startDetection);
        document.getElementById('stopDetectionBtn').addEventListener('click', stopDetection);
        document.getElementById('statusBtn').addEventListener('click', checkStatus);
        document.getElementById('clearLogBtn').addEventListener('click', clearLog);
        
        // 頁面載入時的初始化
        addLog('🚀 系統初始化完成');
        addLog(`🌐 API 基礎地址: ${API_BASE}`);
        addLog(`🔌 WebSocket 地址: ${WS_URL}`);
        addLog('💡 請先點擊「連接 WebSocket」開始！');
        
        // 自動連接 WebSocket
        setTimeout(() => {
            addLog('🔄 自動連接 WebSocket...');
            connectWebSocket();
        }, 1000);
    </script>
</body>
</html>
