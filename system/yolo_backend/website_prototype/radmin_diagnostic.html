<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radmin API 診斷工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .error { background-color: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .info { background-color: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; }
        .warning { background-color: #fff3cd; color: #856404; border-left: 5px solid #ffc107; }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        
        .config-display {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            border: 1px solid #e9ecef;
            margin: 15px 0;
            white-space: pre-wrap;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .clear-btn {
            background-color: #6c757d;
        }
        
        .clear-btn:hover {
            background-color: #545b62;
        }
        
        .version-info {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Radmin 網絡 API 診斷工具</h1>
        <p><strong>版本:</strong> v2.0 - 快取清除版本</p>
        <p>此工具用於診斷和測試 Radmin 網絡環境下的 API 連接問題</p>
        
        <h2>📊 當前環境配置</h2>
        <div class="config-display" id="envConfig">載入中...</div>
        
        <h2>🧪 連接測試</h2>
        <div class="test-grid">
            <button onclick="testEnvironmentDetection()">🌐 環境偵測</button>
            <button onclick="testAPIHealth()">💓 健康檢查</button>
            <button onclick="testAPIStats()">📊 系統統計</button>
            <button onclick="testWebSocket()">🔗 WebSocket</button>
            <button onclick="testAllEndpoints()">🎯 所有端點</button>
            <button onclick="clearResults()" class="clear-btn">🧹 清除日誌</button>
        </div>
        
        <h2>📋 測試結果</h2>
        <div id="results"></div>
        
        <div class="version-info">
            最後更新: 2025-08-10 | 快取版本: v20250810-2
        </div>
    </div>

    <!-- 加載配置文件 -->
    <script src="api-config.js?v=20250810-2"></script>
    
    <script>
        // 測試用的 API 配置（確保使用最新版本）
        const TEST_API_CONFIG = {
            get baseURL() {
                const currentHost = window.location.hostname;
                console.log('🔍 當前主機名稱:', currentHost);
                
                if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                    console.log('✅ 偵測為本機環境，使用 localhost:8001');
                    return 'http://localhost:8001';
                } else {
                    console.log(`✅ 偵測為遠端環境，使用 ${currentHost}:8001`);
                    return `http://${currentHost}:8001`;
                }
            },
            
            get websocketURL() {
                const currentHost = window.location.hostname;
                if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                    return 'ws://localhost:8001/ws/system-stats';
                } else {
                    return `ws://${currentHost}:8001/ws/system-stats`;
                }
            }
        };

        // 顯示結果
        function showResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // 更新環境配置顯示
        function updateEnvironmentConfig() {
            const config = {
                '當前頁面URL': window.location.href,
                '主機名稱': window.location.hostname,
                '端口': window.location.port || '預設',
                '協議': window.location.protocol,
                'API 基礎地址': TEST_API_CONFIG.baseURL,
                'WebSocket 地址': TEST_API_CONFIG.websocketURL,
                '瀏覽器': navigator.userAgent.split(' ').pop(),
                '時間戳': new Date().toLocaleString()
            };
            
            let configText = '';
            for (const [key, value] of Object.entries(config)) {
                configText += `${key}: ${value}\n`;
            }
            
            document.getElementById('envConfig').textContent = configText;
        }

        // 測試環境偵測
        function testEnvironmentDetection() {
            showResult('🔄 開始環境偵測測試...', 'info');
            
            const hostname = window.location.hostname;
            const detectedEnv = (hostname === 'localhost' || hostname === '127.0.0.1') ? '本機' : 'Radmin網絡';
            const apiBase = TEST_API_CONFIG.baseURL;
            const wsBase = TEST_API_CONFIG.websocketURL;
            
            showResult(`✅ 偵測結果: ${detectedEnv} (${hostname})`, 'success');
            showResult(`📡 API 地址: ${apiBase}`, 'success');
            showResult(`🔗 WebSocket 地址: ${wsBase}`, 'success');
            
            // 檢查是否有舊的配置
            if (apiBase.includes('127.0.0.1')) {
                showResult('⚠️ 警告: 偵測到 127.0.0.1 地址，這可能導致 Radmin 訪問問題', 'warning');
            }
        }

        // 測試 API 健康檢查
        async function testAPIHealth() {
            showResult('🔄 開始健康檢查測試...', 'info');
            
            try {
                const url = `${TEST_API_CONFIG.baseURL}/api/v1/health`;
                showResult(`📡 請求 URL: ${url}`, 'info');
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ 健康檢查成功: ${JSON.stringify(data)}`, 'success');
                } else {
                    showResult(`❌ 健康檢查失敗: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 健康檢查錯誤: ${error.message}`, 'error');
                if (error.message.includes('Failed to fetch')) {
                    showResult(`💡 提示: 這通常表示無法連接到服務器，請檢查服務是否運行`, 'warning');
                }
            }
        }

        // 測試系統統計 API
        async function testAPIStats() {
            showResult('🔄 開始系統統計測試...', 'info');
            
            try {
                const url = `${TEST_API_CONFIG.baseURL}/api/v1/frontend/stats`;
                showResult(`📡 請求 URL: ${url}`, 'info');
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ 系統統計成功: CPU: ${data.cpu}%, 記憶體: ${data.memory}%`, 'success');
                } else {
                    showResult(`❌ 系統統計失敗: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 系統統計錯誤: ${error.message}`, 'error');
            }
        }

        // 測試 WebSocket 連接
        function testWebSocket() {
            showResult('🔄 開始 WebSocket 測試...', 'info');
            
            try {
                const wsUrl = TEST_API_CONFIG.websocketURL;
                showResult(`🔗 WebSocket URL: ${wsUrl}`, 'info');
                
                const ws = new WebSocket(wsUrl);
                let messageCount = 0;
                
                ws.onopen = function() {
                    showResult('✅ WebSocket 連接成功', 'success');
                    setTimeout(() => {
                        ws.close();
                        showResult('🔒 WebSocket 測試完成，連接已關閉', 'info');
                    }, 5000);
                };
                
                ws.onmessage = function(event) {
                    messageCount++;
                    if (messageCount === 1) {
                        showResult(`📨 收到第一條訊息: ${event.data.substring(0, 100)}...`, 'success');
                    }
                };
                
                ws.onerror = function(error) {
                    showResult(`❌ WebSocket 錯誤: ${error}`, 'error');
                };
                
                ws.onclose = function(event) {
                    const reason = event.wasClean ? '正常關閉' : `異常關閉 (${event.code})`;
                    showResult(`🔌 WebSocket 已關閉: ${reason}`, 'info');
                };
                
            } catch (error) {
                showResult(`❌ WebSocket 建立失敗: ${error.message}`, 'error');
            }
        }

        // 測試所有主要端點
        async function testAllEndpoints() {
            showResult('🎯 開始全面端點測試...', 'info');
            
            const endpoints = [
                '/api/v1/health',
                '/api/v1/frontend/stats', 
                '/api/v1/frontend/models/config',
                '/docs',
                '/admin'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const url = `${TEST_API_CONFIG.baseURL}${endpoint}`;
                    const response = await fetch(url);
                    
                    const status = response.ok ? '✅' : '❌';
                    showResult(`${status} ${endpoint}: ${response.status}`, response.ok ? 'success' : 'error');
                    
                } catch (error) {
                    showResult(`❌ ${endpoint}: ${error.message}`, 'error');
                }
                
                // 短暫延遲避免過快的請求
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            showResult('🏁 全面測試完成', 'info');
        }

        // 清除結果
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            showResult('🧹 日誌已清除', 'info');
        }

        // 頁面載入時初始化
        window.onload = function() {
            updateEnvironmentConfig();
            showResult('🚀 Radmin API 診斷工具已啟動', 'info');
            showResult('💡 建議先執行 "環境偵測" 和 "健康檢查"', 'info');
            
            // 每30秒更新一次環境配置
            setInterval(updateEnvironmentConfig, 30000);
        };
    </script>
</body>
</html>
