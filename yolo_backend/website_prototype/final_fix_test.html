<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¯ æœ€çµ‚ä¿®å¾©é©—è­‰æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-success">ğŸ¯ è³‡æ–™åº«å­—æ®µä¿®å¾© - æœ€çµ‚é©—è­‰</h1>
        
        <div class="alert alert-info">
            <h5>ğŸ“‹ è³‡æ–™åº«è¨­è¨ˆè¦ç¯„</h5>
            <p>æ ¹æ“šè³‡æ–™åº«è¨­è¨ˆæ–‡ä»¶ï¼š</p>
            <ul>
                <li><strong>analysis_tasks è¡¨å­—æ®µï¼š</strong> id, task_type, status, source_info, start_time, end_time, created_at</li>
                <li><strong>æœ‰æ•ˆçš„ task_typeï¼š</strong> 'realtime_camera' | 'video_file'</li>
                <li><strong>æœ‰æ•ˆçš„ statusï¼š</strong> 'pending' | 'running' | 'completed' | 'failed'</li>
            </ul>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹</h3>
                <button class="btn btn-primary btn-lg mb-3" onclick="testFinalFix()">
                    ğŸš€ åŸ·è¡Œæœ€çµ‚ä¿®å¾©é©—è­‰
                </button>
                
                <div class="card">
                    <div class="card-header">æ¸¬è©¦è³‡æ–™</div>
                    <div class="card-body">
                        <pre id="testData" class="bg-light p-2 small"></pre>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>ğŸ“Š æ¸¬è©¦çµæœ</h3>
                <div id="results" class="border p-3 bg-light" style="height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="mt-4 alert alert-warning">
            <h6>ğŸ”§ å·²ä¿®å¾©çš„å•é¡Œ</h6>
            <ol>
                <li>âœ… JavaScript èªæ³•éŒ¯èª¤</li>
                <li>âœ… HTTP 422 type validation éŒ¯èª¤</li>
                <li>âœ… TaskCreate model description å­—æ®µ</li>
                <li>âœ… TaskService method signature å°é½Š</li>
                <li>âœ… AnalysisTask å­—æ®µæ˜ å°„ï¼ˆtask_id â†’ idï¼‰</li>
                <li>âœ… ç‹€æ…‹å€¼æ˜ å°„ï¼ˆcreated â†’ pendingï¼‰</li>
                <li>âœ… ä»»å‹™é¡å‹æ˜ å°„ï¼ˆbatch â†’ video_fileï¼‰</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.hostname + ':8001';
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
            results.innerHTML += `
                <div class="alert ${alertClass} alert-sm mb-2">
                    <small>[${timestamp}]</small> ${message}
                </div>
            `;
            results.scrollTop = results.scrollHeight;
        }
        
        const finalTestData = {
            name: "æœ€çµ‚ä¿®å¾©é©—è­‰æ¸¬è©¦",
            task_type: "batch",  // å‰ç«¯é¡å‹ â†’ æ˜ å°„åˆ° video_file
            camera_id: "final-test-001",
            model_name: "yolov11s",
            confidence: 0.7,
            iou_threshold: 0.5,
            description: "é©—è­‰æ‰€æœ‰å­—æ®µæ˜ å°„å’Œé¡å‹è½‰æ›æ˜¯å¦æ­£ç¢º"
        };
        
        document.getElementById('testData').textContent = JSON.stringify(finalTestData, null, 2);
        
        async function testFinalFix() {
            log('ğŸ¯ é–‹å§‹æœ€çµ‚ä¿®å¾©é©—è­‰æ¸¬è©¦...');
            log('ğŸ“ æ¸¬è©¦é …ç›®ï¼šè³‡æ–™åº«å­—æ®µæ˜ å°„ã€é¡å‹è½‰æ›ã€APIç«¯åˆ°ç«¯æµç¨‹');
            
            try {
                log('ğŸ“¤ ç™¼é€ä»»å‹™å‰µå»ºè«‹æ±‚...');
                const response = await fetch(`${API_BASE}/api/v1/frontend/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(finalTestData)
                });
                
                log(`ğŸ“¥ HTTP ç‹€æ…‹ç¢¼: ${response.status} ${response.statusText}`);
                
                const responseText = await response.text();
                log(`ğŸ“„ åŸå§‹å›æ‡‰: ${responseText.substring(0, 200)}${responseText.length > 200 ? '...' : ''}`);
                
                if (response.ok) {
                    try {
                        const result = JSON.parse(responseText);
                        log('ğŸ‰ ä»»å‹™å‰µå»ºæˆåŠŸï¼', 'success');
                        log(`ğŸ†” ä»»å‹™ID: ${result.task_id}`, 'success');
                        log(`ğŸ’¬ å›æ‡‰è¨Šæ¯: ${result.message}`, 'success');
                        log(`ğŸŸ¢ ç‹€æ…‹: ${result.status}`, 'success');
                        
                        // é©—è­‰æˆåŠŸæŒ‡æ¨™
                        log('âœ… æ‰€æœ‰ä¿®å¾©é …ç›®é©—è­‰é€šéï¼š', 'success');
                        log('  âœ… AnalysisTask å­—æ®µæ˜ å°„æ­£ç¢º', 'success');
                        log('  âœ… ç‹€æ…‹å€¼è½‰æ›æ­£ç¢º (batchâ†’video_file)', 'success');
                        log('  âœ… API ç«¯åˆ°ç«¯æµç¨‹æ­£å¸¸', 'success');
                        log('  âœ… è³‡æ–™åº«ç´„æŸé©—è­‰é€šé', 'success');
                        
                        log('ğŸ† ä¿®å¾©å®Œæˆï¼ç³»çµ±ç¾åœ¨å¯ä»¥æ­£å¸¸å‰µå»ºè¦–é »åˆ†æä»»å‹™', 'success');
                        
                    } catch (parseError) {
                        log('âš ï¸ å›æ‡‰è§£æè­¦å‘Šï¼Œä½†HTTPç‹€æ…‹æ­£å¸¸', 'info');
                        log(`ğŸ“„ å›æ‡‰å…§å®¹: ${responseText}`, 'info');
                    }
                } else {
                    log('âŒ ä»»å‹™å‰µå»ºå¤±æ•—', 'error');
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        if (errorData.detail || errorData.error) {
                            const errorMsg = errorData.detail || errorData.error;
                            log(`ğŸ” éŒ¯èª¤åˆ†æ: ${errorMsg}`, 'error');
                            
                            if (errorMsg.includes('task_id')) {
                                log('ğŸ› æª¢æ¸¬åˆ° task_id å­—æ®µå•é¡Œ - éœ€è¦é€²ä¸€æ­¥ä¿®å¾©', 'error');
                            } else if (errorMsg.includes('constraint')) {
                                log('ğŸ› æª¢æ¸¬åˆ°è³‡æ–™åº«ç´„æŸå•é¡Œ - æª¢æŸ¥é¡å‹/ç‹€æ…‹å€¼', 'error');
                            } else {
                                log('ğŸ› å…¶ä»–éŒ¯èª¤ - éœ€è¦é€²ä¸€æ­¥èª¿æŸ¥', 'error');
                            }
                        }
                    } catch (e) {
                        log('âŒ éŒ¯èª¤å›æ‡‰è§£æå¤±æ•—', 'error');
                        log(`ğŸ“„ åŸå§‹éŒ¯èª¤: ${responseText}`, 'error');
                    }
                }
                
            } catch (networkError) {
                log('âŒ ç¶²è·¯è«‹æ±‚å¤±æ•—', 'error');
                log(`ğŸ”Œ éŒ¯èª¤è©³æƒ…: ${networkError.message}`, 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('âœ… æœ€çµ‚ä¿®å¾©é©—è­‰æ¸¬è©¦é é¢å·²è¼‰å…¥');
            log('ğŸ“‹ æ ¹æ“šè³‡æ–™åº«è¨­è¨ˆæ–‡ä»¶é…ç½®æ¸¬è©¦åƒæ•¸');
            log('ğŸ¯ æº–å‚™é©—è­‰æ‰€æœ‰ä¿®å¾©é …ç›®...');
        });
    </script>
</body>
</html>
