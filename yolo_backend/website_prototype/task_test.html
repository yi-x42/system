<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æ¸¬è©¦ - ä»»å‹™å‰µå»º</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>ğŸ§ª API æ¸¬è©¦ - ä»»å‹™å‰µå»º</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>ğŸ“ è«‹æ±‚é…ç½®</h3>
                <form id="taskForm">
                    <div class="mb-3">
                        <label class="form-label">ä»»å‹™åç¨±</label>
                        <input type="text" class="form-control" id="taskName" value="æ¸¬è©¦å½±ç‰‡åˆ†æ">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä»»å‹™é¡å‹</label>
                        <select class="form-select" id="taskType">
                            <option value="realtime">å³æ™‚åˆ†æ</option>
                            <option value="batch" selected>æ‰¹æ¬¡åˆ†æ</option>
                            <option value="scheduled">æ’ç¨‹åˆ†æ</option>
                            <option value="event">äº‹ä»¶è§¸ç™¼</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è³‡æ–™ä¾†æºID</label>
                        <input type="text" class="form-control" id="cameraId" value="test-video-001">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ¨¡å‹åç¨±</label>
                        <input type="text" class="form-control" id="modelName" value="yolov11s">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¿¡å¿ƒåº¦</label>
                        <input type="number" class="form-control" id="confidence" value="0.5" step="0.01" min="0" max="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IoU é–¾å€¼</label>
                        <input type="number" class="form-control" id="iouThreshold" value="0.45" step="0.01" min="0" max="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æè¿°</label>
                        <textarea class="form-control" id="description">æ¸¬è©¦å½±ç‰‡åˆ†æä»»å‹™</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ğŸš€ å‰µå»ºä»»å‹™</button>
                </form>
            </div>
            
            <div class="col-md-6">
                <h3>ğŸ“Š æ¸¬è©¦çµæœ</h3>
                <div id="results" class="border p-3 bg-light" style="height: 500px; overflow-y: auto;">
                    <p class="text-muted">é»æ“Š "å‰µå»ºä»»å‹™" æŸ¥çœ‹çµæœ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.hostname + ':8001';
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
            results.innerHTML += `
                <div class="alert ${alertClass} alert-sm">
                    <small>[${timestamp}]</small> ${message}
                </div>
            `;
            results.scrollTop = results.scrollHeight;
        }
        
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskData = {
                name: document.getElementById('taskName').value,
                task_type: document.getElementById('taskType').value,
                camera_id: String(document.getElementById('cameraId').value), // ç¢ºä¿å­—ç¬¦ä¸²é¡å‹
                model_name: document.getElementById('modelName').value,
                confidence: parseFloat(document.getElementById('confidence').value),
                iou_threshold: parseFloat(document.getElementById('iouThreshold').value),
                description: document.getElementById('description').value
            };
            
            log('ğŸ“¤ ç™¼é€è«‹æ±‚æ•¸æ“š: ' + JSON.stringify(taskData, null, 2));
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/frontend/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });
                
                log(`ğŸ“¥ å›æ‡‰ç‹€æ…‹: ${response.status} ${response.statusText}`);
                
                const responseText = await response.text();
                log('ğŸ“¥ å›æ‡‰å…§å®¹: ' + responseText);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('âœ… ä»»å‹™å‰µå»ºæˆåŠŸï¼', 'success');
                    log('ğŸ†” ä»»å‹™ID: ' + result.task_id, 'success');
                } else {
                    log('âŒ ä»»å‹™å‰µå»ºå¤±æ•—', 'error');
                    try {
                        const errorData = JSON.parse(responseText);
                        if (errorData.detail) {
                            if (Array.isArray(errorData.detail)) {
                                errorData.detail.forEach(err => {
                                    log(`âŒ é©—è­‰éŒ¯èª¤ ${err.loc?.join('.')}: ${err.msg}`, 'error');
                                });
                            } else {
                                log('âŒ éŒ¯èª¤è©³æƒ…: ' + errorData.detail, 'error');
                            }
                        }
                    } catch (e) {
                        log('âŒ éŒ¯èª¤å›æ‡‰è§£æå¤±æ•—', 'error');
                    }
                }
                
            } catch (error) {
                log('âŒ è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
            }
        });
        
        // é é¢è¼‰å…¥æ™‚æ¸¬è©¦ API é€£æ¥
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/api/v1/health`);
                if (response.ok) {
                    log('âœ… API é€£æ¥æ­£å¸¸', 'success');
                } else {
                    log('âš ï¸ API å›æ‡‰ç•°å¸¸: ' + response.status, 'error');
                }
            } catch (error) {
                log('âŒ API é€£æ¥å¤±æ•—: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
