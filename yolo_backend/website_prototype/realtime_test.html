<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚æª¢æ¸¬æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        .status.connected { background: rgba(40, 167, 69, 0.8); }
        .status.disconnected { background: rgba(220, 53, 69, 0.8); }
        .status.detecting { background: rgba(255, 193, 7, 0.8); color: black; }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .detection-result {
            background: rgba(0, 123, 255, 0.2);
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ffc107;
        }
        input {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: black;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ YOLOv11 å³æ™‚æª¢æ¸¬ç³»çµ±</h1>
    
    <div class="grid">
        <div class="container">
            <h2>ğŸ”— WebSocket é€£æ¥</h2>
            <div id="connectionStatus" class="status disconnected">æœªé€£æ¥</div>
            <button id="connectBtn" class="button btn-primary">é€£æ¥ WebSocket</button>
            <button id="disconnectBtn" class="button btn-danger">æ–·é–‹é€£æ¥</button>
            
            <h3>ğŸ“¹ å³æ™‚æª¢æ¸¬æ§åˆ¶</h3>
            <label>æ”å½±æ©Ÿç´¢å¼•ï¼š</label>
            <input type="number" id="cameraIndex" value="0" min="0" max="10">
            <br><br>
            <button id="startDetectionBtn" class="button btn-success">ğŸš€ å•Ÿå‹•å³æ™‚æª¢æ¸¬</button>
            <button id="stopDetectionBtn" class="button btn-warning">â¹ï¸ åœæ­¢æª¢æ¸¬</button>
            <button id="statusBtn" class="button btn-primary">ğŸ“Š æª¢æŸ¥ç‹€æ…‹</button>
        </div>
        
        <div class="container">
            <h2>ğŸ“Š æª¢æ¸¬ç‹€æ…‹</h2>
            <div id="detectionStatus" class="status disconnected">æœªæª¢æ¸¬</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="detectionCount">0</div>
                    <div>æª¢æ¸¬æ¬¡æ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="messageCount">0</div>
                    <div>WebSocket è¨Šæ¯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="objectCount">0</div>
                    <div>æª¢æ¸¬ç‰©ä»¶ç¸½æ•¸</div>
                </div>
            </div>
            <p><strong>æœ€å¾Œæª¢æ¸¬æ™‚é–“ï¼š</strong> <span id="lastDetection">ç„¡</span></p>
        </div>
    </div>
    
    <div class="container">
        <h2>ğŸ“ ç³»çµ±æ—¥èªŒ</h2>
        <button id="clearLogBtn" class="button btn-warning">æ¸…ç©ºæ—¥èªŒ</button>
        <div id="log" class="log"></div>
    </div>
    
    <div class="container">
        <h2>ğŸ¯ æœ€æ–°æª¢æ¸¬çµæœ</h2>
        <div id="latestResult" class="detection-result">
            <p>ğŸ” ç­‰å¾…æª¢æ¸¬çµæœ...</p>
        </div>
    </div>

    <script>
        let ws = null;
        let detectionCount = 0;
        let messageCount = 0;
        let objectCount = 0;
        
        const API_BASE = 'http://26.86.64.166:8001/api/v1';
        const WS_URL = 'ws://26.86.64.166:8001/ws/detection';
        
        // DOM å…ƒç´ 
        const connectionStatus = document.getElementById('connectionStatus');
        const detectionStatus = document.getElementById('detectionStatus');
        const log = document.getElementById('log');
        const detectionCountSpan = document.getElementById('detectionCount');
        const lastDetectionSpan = document.getElementById('lastDetection');
        const messageCountSpan = document.getElementById('messageCount');
        const objectCountSpan = document.getElementById('objectCount');
        const latestResult = document.getElementById('latestResult');
        
        // æ—¥èªŒå‡½æ•¸
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #aaa;">[${timestamp}]</span> ${message}`;
            if (type === 'error') logEntry.style.color = '#ff6b6b';
            if (type === 'success') logEntry.style.color = '#51cf66';
            if (type === 'warning') logEntry.style.color = '#ffd43b';
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        // WebSocket é€£æ¥
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('âš ï¸ WebSocket å·²ç¶“é€£æ¥', 'warning');
                return;
            }
            
            addLog('ğŸ”„ æ­£åœ¨é€£æ¥ WebSocket...');
            ws = new WebSocket(WS_URL);
            
            ws.onopen = function() {
                addLog('âœ… WebSocket é€£æ¥æˆåŠŸï¼', 'success');
                connectionStatus.textContent = 'å·²é€£æ¥';
                connectionStatus.className = 'status connected';
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                messageCountSpan.textContent = messageCount;
                
                try {
                    const data = JSON.parse(event.data);
                    addLog(`ğŸ“¨ æ”¶åˆ°è¨Šæ¯: ${data.type}`, 'success');
                    
                    if (data.type === 'detection_result') {
                        detectionCount++;
                        detectionCountSpan.textContent = detectionCount;
                        lastDetectionSpan.textContent = new Date().toLocaleTimeString();
                        
                        // çµ±è¨ˆæª¢æ¸¬åˆ°çš„ç‰©ä»¶æ•¸é‡
                        if (data.detections) {
                            objectCount += data.detections.length;
                            objectCountSpan.textContent = objectCount;
                        }
                        
                        // æ›´æ–°æœ€æ–°æª¢æ¸¬çµæœ
                        const objectsDetected = data.detections ? data.detections.length : 0;
                        latestResult.innerHTML = `
                            <h4>ğŸ¯ æª¢æ¸¬çµæœ #${detectionCount}</h4>
                            <p><strong>ğŸ“‹ ä»»å‹™ID:</strong> ${data.task_id}</p>
                            <p><strong>ğŸ“¹ æ”å½±æ©Ÿ:</strong> ${data.camera_index}</p>
                            <p><strong>ğŸ”¢ æª¢æ¸¬ç‰©ä»¶æ•¸:</strong> ${objectsDetected}</p>
                            <p><strong>â° æ™‚é–“:</strong> ${data.timestamp}</p>
                            ${data.detections && data.detections.length > 0 ? 
                                '<p><strong>ğŸ¯ æª¢æ¸¬åˆ°çš„ç‰©ä»¶:</strong><br>' + 
                                data.detections.map(d => 
                                    `&nbsp;&nbsp;&nbsp;&nbsp;â€¢ ${d.class_name} (ä¿¡å¿ƒåº¦: ${(d.confidence * 100).toFixed(1)}%)`
                                ).join('<br>') + 
                                '</p>' : '<p>âŒ æœªæª¢æ¸¬åˆ°ç‰©ä»¶</p>'
                            }
                        `;
                        
                        // è¨˜éŒ„æª¢æ¸¬è©³æƒ…
                        if (data.detections && data.detections.length > 0) {
                            addLog(`ğŸ¯ æª¢æ¸¬åˆ° ${data.detections.length} å€‹ç‰©ä»¶: ${data.detections.map(d => d.class_name).join(', ')}`, 'success');
                        }
                    }
                } catch (e) {
                    addLog(`âŒ è§£æè¨Šæ¯å¤±æ•—: ${e.message}`, 'error');
                }
            };
            
            ws.onclose = function() {
                addLog('ğŸ”Œ WebSocket é€£æ¥å·²æ–·é–‹', 'warning');
                connectionStatus.textContent = 'æœªé€£æ¥';
                connectionStatus.className = 'status disconnected';
            };
            
            ws.onerror = function(error) {
                addLog(`âŒ WebSocket éŒ¯èª¤: ${error}`, 'error');
            };
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                addLog('ğŸ”Œ æ‰‹å‹•æ–·é–‹ WebSocket é€£æ¥');
            }
        }
        
        // API èª¿ç”¨
        async function apiCall(url, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                addLog(`ğŸ”„ API èª¿ç”¨: ${method} ${url.replace(API_BASE, '')}`);
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`âœ… API èª¿ç”¨æˆåŠŸ`, 'success');
                    console.log('API å›æ‡‰:', data);
                    return data;
                } else {
                    addLog(`âŒ API èª¿ç”¨å¤±æ•—: ${response.status} - ${JSON.stringify(data)}`, 'error');
                    return null;
                }
            } catch (error) {
                addLog(`âŒ API èª¿ç”¨éŒ¯èª¤: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function startDetection() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            addLog(`ğŸš€ æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿ ${cameraIndex} çš„å³æ™‚æª¢æ¸¬...`);
            const result = await apiCall(`${API_BASE}/realtime/start/${cameraIndex}`, 'POST');
            
            if (result) {
                detectionStatus.textContent = 'æª¢æ¸¬ä¸­';
                detectionStatus.className = 'status detecting';
                addLog(`âœ… å³æ™‚æª¢æ¸¬å·²å•Ÿå‹•ï¼Œä»»å‹™ID: ${result.task_id}`, 'success');
            }
        }
        
        async function stopDetection() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            addLog(`â¹ï¸ æ­£åœ¨åœæ­¢æ”å½±æ©Ÿ ${cameraIndex} çš„å³æ™‚æª¢æ¸¬...`);
            const result = await apiCall(`${API_BASE}/realtime/stop/${cameraIndex}`, 'POST');
            
            if (result) {
                detectionStatus.textContent = 'å·²åœæ­¢';
                detectionStatus.className = 'status disconnected';
                addLog(`âœ… å³æ™‚æª¢æ¸¬å·²åœæ­¢ï¼Œç¸½æª¢æ¸¬æ•¸: ${result.total_detections}`, 'success');
            }
        }
        
        async function checkStatus() {
            const cameraIndex = document.getElementById('cameraIndex').value;
            addLog(`ğŸ“Š æª¢æŸ¥æ”å½±æ©Ÿ ${cameraIndex} çš„æª¢æ¸¬ç‹€æ…‹...`);
            const result = await apiCall(`${API_BASE}/realtime/status/${cameraIndex}`);
            
            if (result) {
                if (result.running) {
                    detectionStatus.textContent = 'æª¢æ¸¬ä¸­';
                    detectionStatus.className = 'status detecting';
                    addLog(`âœ… æª¢æ¸¬ç‹€æ…‹: é‹è¡Œä¸­`, 'success');
                    addLog(`ğŸ“‹ ä»»å‹™ID: ${result.task_id}, æª¢æ¸¬æ•¸é‡: ${result.detection_count}`);
                } else {
                    detectionStatus.textContent = 'æœªæª¢æ¸¬';
                    detectionStatus.className = 'status disconnected';
                    addLog(`â„¹ï¸ æª¢æ¸¬ç‹€æ…‹: æœªé‹è¡Œ`, 'info');
                }
            }
        }
        
        function clearLog() {
            log.innerHTML = '';
            addLog('ğŸ§¹ æ—¥èªŒå·²æ¸…ç©º');
        }
        
        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('connectBtn').addEventListener('click', connectWebSocket);
        document.getElementById('disconnectBtn').addEventListener('click', disconnectWebSocket);
        document.getElementById('startDetectionBtn').addEventListener('click', startDetection);
        document.getElementById('stopDetectionBtn').addEventListener('click', stopDetection);
        document.getElementById('statusBtn').addEventListener('click', checkStatus);
        document.getElementById('clearLogBtn').addEventListener('click', clearLog);
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        addLog('ğŸš€ ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        addLog(`ğŸŒ API åŸºç¤åœ°å€: ${API_BASE}`);
        addLog(`ğŸ”Œ WebSocket åœ°å€: ${WS_URL}`);
        addLog('ğŸ’¡ è«‹å…ˆé»æ“Šã€Œé€£æ¥ WebSocketã€é–‹å§‹ï¼');
        
        // è‡ªå‹•é€£æ¥ WebSocket
        setTimeout(() => {
            addLog('ğŸ”„ è‡ªå‹•é€£æ¥ WebSocket...');
            connectWebSocket();
        }, 1000);
    </script>
</body>
</html>
