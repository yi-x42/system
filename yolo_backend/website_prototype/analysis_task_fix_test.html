<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”§ AnalysisTask å­—æ®µä¿®å¾©æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>ğŸ”§ AnalysisTask å­—æ®µä¿®å¾©æ¸¬è©¦</h1>
        <div class="alert alert-success">
            <h5>âœ… ä¿®å¾©å…§å®¹</h5>
            <p>ä¿®æ­£ <code>task_service_new.py</code> ä¸­ <code>AnalysisTask</code> å‰µå»ºæ™‚ä½¿ç”¨çš„ç„¡æ•ˆå­—æ®µ</p>
            <ul>
                <li>âŒ <code>task_id</code> â†’ âœ… å­˜å„²åœ¨ <code>source_info</code> ä¸­</li>
                <li>âŒ <code>task_name</code> â†’ âœ… å­˜å„²åœ¨ <code>source_info</code> ä¸­</li>
                <li>âŒ <code>config</code> â†’ âœ… å­˜å„²åœ¨ <code>source_info</code> ä¸­</li>
                <li>âŒ <code>progress</code> â†’ âœ… ç§»é™¤ï¼ˆæ¨¡å‹ä¸­ä¸å­˜åœ¨ï¼‰</li>
            </ul>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>ğŸ§ª æ¸¬è©¦å€åŸŸ</h3>
                <button class="btn btn-success btn-lg mb-3" onclick="testFixedTask()">
                    ğŸš€ æ¸¬è©¦ä¿®å¾©å¾Œçš„ä»»å‹™å‰µå»º
                </button>
                
                <div class="alert alert-info">
                    <h6>ğŸ“‹ æ¨¡å‹å°æ‡‰é—œä¿‚</h6>
                    <table class="table table-sm">
                        <tr><th>AnalysisTask å­—æ®µ</th><th>ä½¿ç”¨æ–¹å¼</th></tr>
                        <tr><td>task_type</td><td>ç›´æ¥ä½¿ç”¨</td></tr>
                        <tr><td>status</td><td>"created"</td></tr>
                        <tr><td>source_info</td><td>åŒ…å«æ‰€æœ‰é…ç½®</td></tr>
                        <tr><td>created_at</td><td>ç•¶å‰æ™‚é–“</td></tr>
                    </table>
                </div>
                
                <h5>æ¸¬è©¦æ•¸æ“š:</h5>
                <pre id="testData" class="bg-light p-3 small"></pre>
            </div>
            
            <div class="col-md-6">
                <h3>ğŸ“Š æ¸¬è©¦çµæœ</h3>
                <div id="results" class="border p-3 bg-light" style="height: 500px; overflow-y: auto;">
                    <p class="text-muted">ç­‰å¾…ç³»çµ±é‡è¼‰å®Œæˆå¾Œé»æ“Šæ¸¬è©¦...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.hostname + ':8001';
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
            results.innerHTML += `
                <div class="alert ${alertClass} alert-sm mb-2">
                    <small>[${timestamp}]</small> ${message}
                </div>
            `;
            results.scrollTop = results.scrollHeight;
        }
        
        const testTaskData = {
            name: "AnalysisTask ä¿®å¾©æ¸¬è©¦",
            task_type: "batch",
            camera_id: "fix-test-001",
            model_name: "yolov11s",
            confidence: 0.7,
            iou_threshold: 0.5,
            description: "æ¸¬è©¦ AnalysisTask å­—æ®µä¿®å¾©æ˜¯å¦æˆåŠŸ"
        };
        
        document.getElementById('testData').textContent = JSON.stringify(testTaskData, null, 2);
        
        async function testFixedTask() {
            log('ğŸ”§ æ¸¬è©¦ AnalysisTask å­—æ®µä¿®å¾©...');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/frontend/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testTaskData)
                });
                
                log(`ğŸ“¥ å›æ‡‰ç‹€æ…‹: ${response.status} ${response.statusText}`);
                
                const responseText = await response.text();
                log(`ğŸ“¥ å›æ‡‰å…§å®¹: ${responseText}`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('ğŸ‰ ä»»å‹™å‰µå»ºæˆåŠŸï¼', 'success');
                    log(`ğŸ†” ä»»å‹™ID: ${result.task_id}`, 'success');
                    log('âœ… AnalysisTask å­—æ®µä¿®å¾©æˆåŠŸï¼', 'success');
                    log('âœ… è³‡æ–™åº«å­˜å„²æ­£å¸¸ï¼', 'success');
                } else {
                    log('âŒ ä»»å‹™å‰µå»ºå¤±æ•—', 'error');
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        if (errorData.error) {
                            log(`âŒ éŒ¯èª¤è©³æƒ…: ${errorData.error}`, 'error');
                            
                            if (errorData.error.includes('invalid keyword argument')) {
                                log('âŒ ä»ç„¶å­˜åœ¨å­—æ®µåç¨±å•é¡Œ', 'error');
                            }
                        }
                    } catch (e) {
                        log('âŒ éŒ¯èª¤å›æ‡‰è§£æå¤±æ•—', 'error');
                    }
                }
                
            } catch (error) {
                log('âŒ è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        window.addEventListener('load', async () => {
            log('â³ æª¢æŸ¥ç³»çµ±é‡è¼‰ç‹€æ…‹...');
            
            // ç­‰å¾…ç³»çµ±é‡è¼‰
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/health`);
                if (response.ok) {
                    log('âœ… ç³»çµ±é‡è¼‰å®Œæˆï¼Œå¯ä»¥é–‹å§‹æ¸¬è©¦', 'success');
                } else {
                    log('âš ï¸ ç³»çµ±ç‹€æ…‹æª¢æŸ¥ç•°å¸¸: ' + response.status, 'error');
                }
            } catch (error) {
                log('âŒ ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
