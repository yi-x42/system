# YOLOv11 數位雙生分析系統 - 資料庫結構說明

## 📊 資料庫概覽
- **資料庫名稱**: `yolo_analysis`
- **資料庫類型**: PostgreSQL
- **連接資訊**: `localhost:5432`
- **用戶**: `postgres`

---

## 📋 資料表結構詳細說明

### 1. 🗂️ **分析記錄表** (`analysis_records`)
用於儲存每次影片分析的基本資訊和統計結果

| 欄位名稱 | 資料型別 | 是否必填 | 中文說明 | 英文說明 |
|---------|----------|----------|----------|----------|
| `id` | Integer | ✅ | 主鍵ID | Primary Key |
| `created_at` | DateTime | ✅ | 建立時間 | Creation timestamp |
| `updated_at` | DateTime | ❌ | 更新時間 | Last update timestamp |
| `video_path` | String(500) | ✅ | 影片檔案路徑 | Video file path |
| `video_name` | String(255) | ✅ | 影片檔案名稱 | Video file name |
| `analysis_type` | String(50) | ✅ | 分析類型 | Analysis type (detection/annotation) |
| `status` | String(50) | ✅ | 處理狀態 | Processing status |
| `duration` | Float | ❌ | 影片長度(秒) | Video duration in seconds |
| `fps` | Float | ❌ | 幀率 | Frames per second |
| `total_frames` | Integer | ❌ | 總幀數 | Total frame count |
| `resolution` | String(50) | ❌ | 解析度 | Video resolution |
| `total_detections` | Integer | ✅ | 總檢測數量 | Total detection count |
| `unique_objects` | Integer | ✅ | 唯一物件數量 | Unique object count |
| `analysis_duration` | Float | ❌ | 分析耗時(秒) | Analysis processing time |
| `csv_file_path` | String(500) | ❌ | CSV結果檔案路徑 | CSV result file path |
| `annotated_video_path` | String(500) | ❌ | 標註影片檔案路徑 | Annotated video file path |
| `extra_data` | JSON | ❌ | 額外元數據 | Additional metadata |
| `error_message` | Text | ❌ | 錯誤訊息 | Error message if any |

**狀態值說明** (`status`):
- `processing` - 處理中
- `completed` - 已完成
- `failed` - 處理失敗

---

### 2. 🔍 **檢測結果表** (`detection_results`)
用於儲存每個檢測到的物件詳細資訊

| 欄位名稱 | 資料型別 | 是否必填 | 中文說明 | 英文說明 |
|---------|----------|----------|----------|----------|
| `id` | Integer | ✅ | 主鍵ID | Primary Key |
| `created_at` | DateTime | ✅ | 建立時間 | Creation timestamp |
| `updated_at` | DateTime | ❌ | 更新時間 | Last update timestamp |
| `analysis_id` | Integer | ✅ | 關聯分析記錄ID | Related analysis record ID |
| `timestamp` | DateTime | ✅ | 檢測時間 | Detection timestamp |
| `frame_number` | Integer | ✅ | 幀編號 | Frame number |
| `frame_time` | Float | ✅ | 影片時間點(秒) | Video time position |
| `object_id` | String(100) | ❌ | 物件追蹤ID | Object tracking ID |
| `object_type` | String(50) | ✅ | 物件類型 | Object type (person/car/etc) |
| `object_chinese` | String(50) | ❌ | 物件中文名稱 | Chinese name of object |
| `confidence` | Float | ✅ | 信心度 | Detection confidence score |
| `bbox_x1` | Float | ✅ | 邊界框左上X座標 | Bounding box top-left X |
| `bbox_y1` | Float | ✅ | 邊界框左上Y座標 | Bounding box top-left Y |
| `bbox_x2` | Float | ✅ | 邊界框右下X座標 | Bounding box bottom-right X |
| `bbox_y2` | Float | ✅ | 邊界框右下Y座標 | Bounding box bottom-right Y |
| `center_x` | Float | ✅ | 物件中心X座標 | Object center X coordinate |
| `center_y` | Float | ✅ | 物件中心Y座標 | Object center Y coordinate |
| `width` | Float | ✅ | 物件寬度 | Object width |
| `height` | Float | ✅ | 物件高度 | Object height |
| `area` | Float | ✅ | 物件面積 | Object area |
| `zone` | String(50) | ❌ | 檢測區域 | Detection zone |
| `zone_chinese` | String(50) | ❌ | 區域中文名稱 | Chinese zone name |
| `velocity_x` | Float | ❌ | X方向速度 | Velocity in X direction |
| `velocity_y` | Float | ❌ | Y方向速度 | Velocity in Y direction |
| `direction_angle` | Float | ❌ | 移動方向角度 | Movement direction angle |
| `direction_chinese` | String(20) | ❌ | 移動方向中文 | Chinese direction name |
| `detection_quality` | String(20) | ❌ | 檢測品質評估 | Detection quality assessment |

**常見物件類型** (`object_type`):
- `person` - 人 (`object_chinese`: 人)
- `car` - 汽車 (`object_chinese`: 汽車)
- `truck` - 卡車 (`object_chinese`: 卡車)
- `bus` - 巴士 (`object_chinese`: 巴士)
- `bicycle` - 腳踏車 (`object_chinese`: 腳踏車)
- `motorcycle` - 機車 (`object_chinese`: 機車)

**區域類型** (`zone`):
- `center` - 中央區域 (`zone_chinese`: 中央區域)
- `left` - 左側區域 (`zone_chinese`: 左側區域)
- `right` - 右側區域 (`zone_chinese`: 右側區域)
- `top` - 上方區域 (`zone_chinese`: 上方區域)
- `bottom` - 下方區域 (`zone_chinese`: 下方區域)

---

### 3. 🎯 **行為事件表** (`behavior_events`)
用於儲存檢測到的行為事件和異常狀況

| 欄位名稱 | 資料型別 | 是否必填 | 中文說明 | 英文說明 |
|---------|----------|----------|----------|----------|
| `id` | Integer | ✅ | 主鍵ID | Primary Key |
| `created_at` | DateTime | ✅ | 建立時間 | Creation timestamp |
| `updated_at` | DateTime | ❌ | 更新時間 | Last update timestamp |
| `analysis_id` | Integer | ✅ | 關聯分析記錄ID | Related analysis record ID |
| `timestamp` | DateTime | ✅ | 事件發生時間 | Event timestamp |
| `event_type` | String(50) | ✅ | 事件類型 | Event type |
| `event_chinese` | String(50) | ❌ | 事件中文名稱 | Chinese event name |
| `object_type` | String(50) | ✅ | 相關物件類型 | Related object type |
| `object_chinese` | String(50) | ❌ | 物件中文名稱 | Chinese object name |
| `object_id` | String(100) | ❌ | 物件追蹤ID | Object tracking ID |
| `confidence` | Float | ✅ | 事件信心度 | Event confidence score |
| `duration` | Float | ❌ | 事件持續時間(秒) | Event duration in seconds |
| `severity` | String(20) | ❌ | 嚴重程度 | Severity level |
| `description` | Text | ❌ | 事件描述 | Event description |
| `zone` | String(50) | ❌ | 發生區域 | Event zone |
| `zone_chinese` | String(50) | ❌ | 區域中文名稱 | Chinese zone name |
| `additional_data` | JSON | ❌ | 額外事件資料 | Additional event data |

**行為事件類型** (`event_type`):
- `movement` - 移動 (`event_chinese`: 移動)
- `stop` - 停止 (`event_chinese`: 停止)
- `enter_zone` - 進入區域 (`event_chinese`: 進入區域)
- `exit_zone` - 離開區域 (`event_chinese`: 離開區域)
- `crowding` - 聚集 (`event_chinese`: 聚集)
- `speeding` - 快速移動 (`event_chinese`: 快速移動)
- `loitering` - 徘徊 (`event_chinese`: 徘徊)

**嚴重程度** (`severity`):
- `low` - 低 (一般事件)
- `medium` - 中 (需要注意)
- `high` - 高 (需要立即處理)

---

## 🔗 **資料表關聯圖**

```
analysis_records (分析記錄)
    │
    ├─→ detection_results (檢測結果)
    │   ∟ 一對多關聯 (analysis_id)
    │
    └─→ behavior_events (行為事件)
        ∟ 一對多關聯 (analysis_id)
```

---

## 📝 **常用查詢範例**

### 1. 查看最近的分析記錄
```sql
SELECT id, video_name, analysis_type, status, total_detections, created_at 
FROM analysis_records 
ORDER BY created_at DESC 
LIMIT 10;
```

### 2. 查看特定分析的檢測結果
```sql
SELECT object_chinese, confidence, center_x, center_y 
FROM detection_results 
WHERE analysis_id = 1 
ORDER BY confidence DESC;
```

### 3. 統計各物件類型的檢測數量
```sql
SELECT object_chinese, COUNT(*) as count 
FROM detection_results 
GROUP BY object_chinese 
ORDER BY count DESC;
```

### 4. 查看高信心度的檢測結果
```sql
SELECT ar.video_name, dr.object_chinese, dr.confidence 
FROM analysis_records ar 
JOIN detection_results dr ON ar.id = dr.analysis_id 
WHERE dr.confidence > 0.8;
```

### 5. 查看行為事件統計
```sql
SELECT event_chinese, COUNT(*) as count 
FROM behavior_events 
GROUP BY event_chinese 
ORDER BY count DESC;
```

---

## 🛠️ **資料庫管理工具**

### **連接資訊**
- **主機**: localhost
- **端口**: 5432
- **資料庫**: yolo_analysis
- **用戶名**: postgres
- **密碼**: 49679904

### **推薦工具**
1. **pgAdmin** - 圖形化管理介面
2. **psql** - 命令列工具
3. **DBeaver** - 跨平台資料庫工具

### **Python 查看腳本**
```bash
# 使用專案內建的診斷腳本
python diagnose_db.py
```

---

## 📊 **API 端點對照**

| API 端點 | 功能 | 相關資料表 |
|---------|------|-----------|
| `POST /api/v1/analysis/upload-with-database` | 上傳影片分析 | 所有表格 |
| `GET /api/v1/analysis/history` | 獲取分析歷史 | analysis_records |
| `GET /api/v1/analysis/{id}` | 獲取特定分析詳情 | 所有表格 |
| `GET /api/v1/analysis/statistics` | 獲取統計資訊 | 所有表格 |

---

## 🔍 **故障排除**

### 常見問題
1. **檢測結果為空**: 檢查 `total_detections` 欄位是否為 0
2. **影片分析失敗**: 查看 `error_message` 欄位
3. **資料庫連接問題**: 確認 PostgreSQL 服務是否運行

### 聯絡資訊
- **開發者**: [您的姓名]
- **專案位置**: `d:\project\system\yolo_backend\`
- **最後更新**: 2025年7月20日

---

*此文件由 YOLOv11 數位雙生分析系統自動生成*
