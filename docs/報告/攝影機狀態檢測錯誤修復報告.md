# 攝影機狀態檢測錯誤修復報告

## 🐛 問題分析

### 錯誤 1: 資料庫約束違反
```
sqlalchemy.dialects.postgresql.asyncpg.IntegrityError: new row for relation "data_sources" violates check constraint "data_sources_status_check"
DETAIL: Failing row contains (..., unknown, ...)
```

**原因：**
- 資料庫中 `data_sources` 表有檢查約束 `data_sources_status_check`
- 該約束只允許 `'active'`、`'inactive'`、`'error'` 三種狀態值
- 但程式碼中使用了 `'unknown'` 狀態，違反了資料庫約束

### 錯誤 2: 攝影機配置檢測問題
```
攝影機 攝影機 0 配置不完整或類型未知
```

**原因：**
- 攝影機配置檢測邏輯不完善
- 未能正確識別 `device_index` 配置項
- 對於配置不完整的情況處理不當

## 🔧 修復方案

### 1. 狀態值修復

**修改檔案：** `yolo_backend/app/services/camera_status_monitor.py`

**修改內容：**
```python
# 修復前
class CameraConnectionStatus:
    ONLINE = "active"
    OFFLINE = "inactive"
    ERROR = "error"
    UNKNOWN = "unknown"  # ❌ 違反資料庫約束

# 修復後
class CameraConnectionStatus:
    ONLINE = "active"
    OFFLINE = "inactive"
    ERROR = "error"  # ✅ 移除 UNKNOWN 狀態
```

**影響：**
- 所有原本返回 `unknown` 的地方現在返回 `error`
- 符合資料庫的 `data_sources_status_check` 約束
- 狀態語義更加清晰：未知配置被視為錯誤狀態

### 2. 攝影機配置檢測邏輯改善

**修改內容：**

1. **支援多種設備ID配置：**
```python
# 修復前
elif "device_id" in config:
    usb_ok = await self.test_usb_camera(config["device_id"])

# 修復後  
elif "device_id" in config or "device_index" in config:
    device_id = config.get("device_id") or config.get("device_index", 0)
    usb_ok = await self.test_usb_camera(device_id)
```

2. **更好的錯誤處理：**
```python
# 修復前
logger.warning(f"攝影機 {camera.name} 配置不完整或類型未知")
return CameraConnectionStatus.UNKNOWN

# 修復後
logger.warning(f"攝影機 {camera.name} 配置不完整：{config}")
return CameraConnectionStatus.ERROR
```

3. **增強檔案路徑檢查：**
```python
# 修復前
file_path = config.get("file_path", "")
if os.path.exists(file_path):

# 修復後
file_path = config.get("file_path", "")
if file_path and os.path.exists(file_path):
```

### 3. 資料庫模型註釋更新

**修改檔案：** `yolo_backend/app/models/database.py`

```python
# 修復後
status = Column(String(20), nullable=False, default='active')  # 'active' | 'inactive' | 'error' (資料庫約束限制)
```

## ✅ 修復驗證

### 測試腳本
建立了 `test_camera_status_fix.py` 驗證修復效果：

1. **基本攝影機列表測試** - 檢查狀態值是否合法
2. **即時檢測測試** - 重點測試是否還有約束違反
3. **批量檢測測試** - 驗證大量檢測的穩定性

### 預期結果
- ✅ 不再出現 `unknown` 狀態
- ✅ 所有狀態值符合資料庫約束：`active`、`inactive`、`error`
- ✅ 攝影機配置檢測更加智能
- ✅ 錯誤日誌更加詳細和有用

## 🚀 使用說明

### 1. 重新啟動服務
```bash
python start.py
```

### 2. 運行驗證測試
```bash
cd "test、simple"
python test_camera_status_fix.py
```

### 3. 檢查狀態分佈
- `active` - 攝影機線上且可用
- `inactive` - 攝影機離線或不可用  
- `error` - 配置錯誤或檢測失敗

## 📊 狀態語義說明

| 狀態 | 含義 | 觸發條件 |
|------|------|----------|
| `active` | 線上可用 | 攝影機連接成功，串流正常 |
| `inactive` | 離線不可用 | 攝影機無法連接或串流失敗 |
| `error` | 配置錯誤 | 配置不完整、類型未知或檢測異常 |

## 🔄 向後相容性

- API 介面保持不變
- 前端顯示邏輯無需修改
- 資料庫結構無變更
- 只是狀態值語義更加準確

## 📝 後續建議

1. **監控告警：** 對 `error` 狀態的攝影機設置告警
2. **配置驗證：** 在添加攝影機時預先驗證配置完整性
3. **狀態歷史：** 記錄狀態變更歷史便於排錯
4. **自動修復：** 對常見配置錯誤提供自動修復建議

---

**修復時間：** 2025年9月22日
**影響範圍：** 攝影機狀態檢測服務
**測試狀態：** 待驗證