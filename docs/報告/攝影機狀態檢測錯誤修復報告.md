# æ”å½±æ©Ÿç‹€æ…‹æª¢æ¸¬éŒ¯èª¤ä¿®å¾©å ±å‘Š

## ğŸ› å•é¡Œåˆ†æ

### éŒ¯èª¤ 1: è³‡æ–™åº«ç´„æŸé•å
```
sqlalchemy.dialects.postgresql.asyncpg.IntegrityError: new row for relation "data_sources" violates check constraint "data_sources_status_check"
DETAIL: Failing row contains (..., unknown, ...)
```

**åŸå› ï¼š**
- è³‡æ–™åº«ä¸­ `data_sources` è¡¨æœ‰æª¢æŸ¥ç´„æŸ `data_sources_status_check`
- è©²ç´„æŸåªå…è¨± `'active'`ã€`'inactive'`ã€`'error'` ä¸‰ç¨®ç‹€æ…‹å€¼
- ä½†ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨äº† `'unknown'` ç‹€æ…‹ï¼Œé•åäº†è³‡æ–™åº«ç´„æŸ

### éŒ¯èª¤ 2: æ”å½±æ©Ÿé…ç½®æª¢æ¸¬å•é¡Œ
```
æ”å½±æ©Ÿ æ”å½±æ©Ÿ 0 é…ç½®ä¸å®Œæ•´æˆ–é¡å‹æœªçŸ¥
```

**åŸå› ï¼š**
- æ”å½±æ©Ÿé…ç½®æª¢æ¸¬é‚è¼¯ä¸å®Œå–„
- æœªèƒ½æ­£ç¢ºè­˜åˆ¥ `device_index` é…ç½®é …
- å°æ–¼é…ç½®ä¸å®Œæ•´çš„æƒ…æ³è™•ç†ä¸ç•¶

## ğŸ”§ ä¿®å¾©æ–¹æ¡ˆ

### 1. ç‹€æ…‹å€¼ä¿®å¾©

**ä¿®æ”¹æª”æ¡ˆï¼š** `yolo_backend/app/services/camera_status_monitor.py`

**ä¿®æ”¹å…§å®¹ï¼š**
```python
# ä¿®å¾©å‰
class CameraConnectionStatus:
    ONLINE = "active"
    OFFLINE = "inactive"
    ERROR = "error"
    UNKNOWN = "unknown"  # âŒ é•åè³‡æ–™åº«ç´„æŸ

# ä¿®å¾©å¾Œ
class CameraConnectionStatus:
    ONLINE = "active"
    OFFLINE = "inactive"
    ERROR = "error"  # âœ… ç§»é™¤ UNKNOWN ç‹€æ…‹
```

**å½±éŸ¿ï¼š**
- æ‰€æœ‰åŸæœ¬è¿”å› `unknown` çš„åœ°æ–¹ç¾åœ¨è¿”å› `error`
- ç¬¦åˆè³‡æ–™åº«çš„ `data_sources_status_check` ç´„æŸ
- ç‹€æ…‹èªç¾©æ›´åŠ æ¸…æ™°ï¼šæœªçŸ¥é…ç½®è¢«è¦–ç‚ºéŒ¯èª¤ç‹€æ…‹

### 2. æ”å½±æ©Ÿé…ç½®æª¢æ¸¬é‚è¼¯æ”¹å–„

**ä¿®æ”¹å…§å®¹ï¼š**

1. **æ”¯æ´å¤šç¨®è¨­å‚™IDé…ç½®ï¼š**
```python
# ä¿®å¾©å‰
elif "device_id" in config:
    usb_ok = await self.test_usb_camera(config["device_id"])

# ä¿®å¾©å¾Œ  
elif "device_id" in config or "device_index" in config:
    device_id = config.get("device_id") or config.get("device_index", 0)
    usb_ok = await self.test_usb_camera(device_id)
```

2. **æ›´å¥½çš„éŒ¯èª¤è™•ç†ï¼š**
```python
# ä¿®å¾©å‰
logger.warning(f"æ”å½±æ©Ÿ {camera.name} é…ç½®ä¸å®Œæ•´æˆ–é¡å‹æœªçŸ¥")
return CameraConnectionStatus.UNKNOWN

# ä¿®å¾©å¾Œ
logger.warning(f"æ”å½±æ©Ÿ {camera.name} é…ç½®ä¸å®Œæ•´ï¼š{config}")
return CameraConnectionStatus.ERROR
```

3. **å¢å¼·æª”æ¡ˆè·¯å¾‘æª¢æŸ¥ï¼š**
```python
# ä¿®å¾©å‰
file_path = config.get("file_path", "")
if os.path.exists(file_path):

# ä¿®å¾©å¾Œ
file_path = config.get("file_path", "")
if file_path and os.path.exists(file_path):
```

### 3. è³‡æ–™åº«æ¨¡å‹è¨»é‡‹æ›´æ–°

**ä¿®æ”¹æª”æ¡ˆï¼š** `yolo_backend/app/models/database.py`

```python
# ä¿®å¾©å¾Œ
status = Column(String(20), nullable=False, default='active')  # 'active' | 'inactive' | 'error' (è³‡æ–™åº«ç´„æŸé™åˆ¶)
```

## âœ… ä¿®å¾©é©—è­‰

### æ¸¬è©¦è…³æœ¬
å»ºç«‹äº† `test_camera_status_fix.py` é©—è­‰ä¿®å¾©æ•ˆæœï¼š

1. **åŸºæœ¬æ”å½±æ©Ÿåˆ—è¡¨æ¸¬è©¦** - æª¢æŸ¥ç‹€æ…‹å€¼æ˜¯å¦åˆæ³•
2. **å³æ™‚æª¢æ¸¬æ¸¬è©¦** - é‡é»æ¸¬è©¦æ˜¯å¦é‚„æœ‰ç´„æŸé•å
3. **æ‰¹é‡æª¢æ¸¬æ¸¬è©¦** - é©—è­‰å¤§é‡æª¢æ¸¬çš„ç©©å®šæ€§

### é æœŸçµæœ
- âœ… ä¸å†å‡ºç¾ `unknown` ç‹€æ…‹
- âœ… æ‰€æœ‰ç‹€æ…‹å€¼ç¬¦åˆè³‡æ–™åº«ç´„æŸï¼š`active`ã€`inactive`ã€`error`
- âœ… æ”å½±æ©Ÿé…ç½®æª¢æ¸¬æ›´åŠ æ™ºèƒ½
- âœ… éŒ¯èª¤æ—¥èªŒæ›´åŠ è©³ç´°å’Œæœ‰ç”¨

## ğŸš€ ä½¿ç”¨èªªæ˜

### 1. é‡æ–°å•Ÿå‹•æœå‹™
```bash
python start.py
```

### 2. é‹è¡Œé©—è­‰æ¸¬è©¦
```bash
cd "testã€simple"
python test_camera_status_fix.py
```

### 3. æª¢æŸ¥ç‹€æ…‹åˆ†ä½ˆ
- `active` - æ”å½±æ©Ÿç·šä¸Šä¸”å¯ç”¨
- `inactive` - æ”å½±æ©Ÿé›¢ç·šæˆ–ä¸å¯ç”¨  
- `error` - é…ç½®éŒ¯èª¤æˆ–æª¢æ¸¬å¤±æ•—

## ğŸ“Š ç‹€æ…‹èªç¾©èªªæ˜

| ç‹€æ…‹ | å«ç¾© | è§¸ç™¼æ¢ä»¶ |
|------|------|----------|
| `active` | ç·šä¸Šå¯ç”¨ | æ”å½±æ©Ÿé€£æ¥æˆåŠŸï¼Œä¸²æµæ­£å¸¸ |
| `inactive` | é›¢ç·šä¸å¯ç”¨ | æ”å½±æ©Ÿç„¡æ³•é€£æ¥æˆ–ä¸²æµå¤±æ•— |
| `error` | é…ç½®éŒ¯èª¤ | é…ç½®ä¸å®Œæ•´ã€é¡å‹æœªçŸ¥æˆ–æª¢æ¸¬ç•°å¸¸ |

## ğŸ”„ å‘å¾Œç›¸å®¹æ€§

- API ä»‹é¢ä¿æŒä¸è®Š
- å‰ç«¯é¡¯ç¤ºé‚è¼¯ç„¡éœ€ä¿®æ”¹
- è³‡æ–™åº«çµæ§‹ç„¡è®Šæ›´
- åªæ˜¯ç‹€æ…‹å€¼èªç¾©æ›´åŠ æº–ç¢º

## ğŸ“ å¾ŒçºŒå»ºè­°

1. **ç›£æ§å‘Šè­¦ï¼š** å° `error` ç‹€æ…‹çš„æ”å½±æ©Ÿè¨­ç½®å‘Šè­¦
2. **é…ç½®é©—è­‰ï¼š** åœ¨æ·»åŠ æ”å½±æ©Ÿæ™‚é å…ˆé©—è­‰é…ç½®å®Œæ•´æ€§
3. **ç‹€æ…‹æ­·å²ï¼š** è¨˜éŒ„ç‹€æ…‹è®Šæ›´æ­·å²ä¾¿æ–¼æ’éŒ¯
4. **è‡ªå‹•ä¿®å¾©ï¼š** å°å¸¸è¦‹é…ç½®éŒ¯èª¤æä¾›è‡ªå‹•ä¿®å¾©å»ºè­°

---

**ä¿®å¾©æ™‚é–“ï¼š** 2025å¹´9æœˆ22æ—¥
**å½±éŸ¿ç¯„åœï¼š** æ”å½±æ©Ÿç‹€æ…‹æª¢æ¸¬æœå‹™
**æ¸¬è©¦ç‹€æ…‹ï¼š** å¾…é©—è­‰